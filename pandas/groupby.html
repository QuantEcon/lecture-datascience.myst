

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>GroupBy &#8212; QuantEcon DataScience</title>
    <script src="https://unpkg.com/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://unpkg.com/tippy.js@6.3.1/dist/tippy-bundle.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    
        <script>
            MathJax = {
            loader: {load: ['[tex]/boldsymbol', '[tex]/textmacros']},
            tex: {
                packages: {'[+]': ['boldsymbol', 'textmacros']},
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                processEscapes: true,
                macros: {
                    "argmax" : "arg\\,max",
                    "argmin" : "arg\\,min",
                    "col"    : "col",
                    "Span"   :  "span",
                    "epsilon": "\\varepsilon",
                    "EE": "\\mathbb{E}",
                    "PP": "\\mathbb{P}",
                    "RR": "\\mathbb{R}",
                    "NN": "\\mathbb{N}",
                    "ZZ": "\\mathbb{Z}",
                    "aA": "\\mathcal{A}",
                    "bB": "\\mathcal{B}",
                    "cC": "\\mathcal{C}",
                    "dD": "\\mathcal{D}",
                    "eE": "\\mathcal{E}",
                    "fF": "\\mathcal{F}",
                    "gG": "\\mathcal{G}",
                    "hH": "\\mathcal{H}",
                }
            },
            svg: {
                fontCache: 'global',
                scale: 0.92,
                displayAlign: "center",
            },
            };
        </script>
    
    
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/quantecon-book-theme.279dae03c5caae754d20501e3fa00bbf.css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/exercise.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d" />


    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script src="../_static/quantecon-book-theme.15b0c36fffe88f468997fa7b698991d3.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'pandas/groupby';</script>
    <link rel="canonical" href="https://datascience.quantecon.org/pandas/groupby.html" />
    <link rel="shortcut icon" href="../_static/lectures-favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Time series" href="timeseries.html" />
    <link rel="prev" title="Merge" href="merge.html" />

<!-- Normal Meta Tags -->
<meta name="author" context="Chase Coleman, Spencer Lyon, and Jesse Perla" />
<meta name="keywords" content="Python, QuantEcon, DataScience" />
<meta name="description" content=This website presents a series of lectures on programming, data science, and economics. />

<!-- Twitter tags -->
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@quantecon" />
<meta name="twitter:title" content="GroupBy"/>
<meta name="twitter:description" content="This website presents a series of lectures on programming, data science, and economics.">
<meta name="twitter:creator" content="@quantecon">
<meta name="twitter:image" content="https://assets.quantecon.org/img/qe-twitter-logo.png">

<!-- Opengraph tags -->
<meta property="og:title" content="GroupBy" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://datascience.quantecon.org/pandas/groupby.html" />
<meta property="og:image" content="https://assets.quantecon.org/img/qe-og-logo.png" />
<meta property="og:description" content="This website presents a series of lectures on programming, data science, and economics." />
<meta property="og:site_name" content="QuantEcon DataScience" />
<meta name="theme-color" content="#ffffff" />

  </head>
<body>


    <span id="top"></span>

    <div class="qe-wrapper">

        <div class="qe-main">

            <div class="qe-page" id=pandas/groupby>

                <div class="qe-page__toc">

                    <div class="inner">

                        
                        <div class="qe-page__toc-header">
                            On this page
                        </div>


                        <nav id="bd-toc-nav" class="qe-page__toc-nav">
                            <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#split-apply-combine">Split-Apply-Combine</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#simple-example">Simple Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-aggregate-functions">Custom Aggregate Functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#transforms-the-apply-method">Transforms: The <code class="docutils literal notranslate"><span class="pre">apply</span></code> Method</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pd-grouper"><code class="docutils literal notranslate"><span class="pre">pd.Grouper</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#case-study-airline-delays">Case Study: Airline Delays</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-cohort-analysis-using-shopify-data">Exercise: Cohort Analysis using Shopify Data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extended-exercise">Extended Exercise</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1">Exercise 1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2">Exercise 2</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3">Exercise 3</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-4">Exercise 4</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-5">Exercise 5</a></li>
</ul>
</li>
</ul>
                            <p class="logo">
                                
                                    
                                    <a href=https://quantecon.org><img src="../_static/datascience-logo.png" class="logo" alt="logo"></a>
                                    
                                
                            </p>

                            <p class="powered">Powered by <a href="https://jupyterbook.org/">Jupyter Book</a></p>

                        </nav>

                        <div class="qe-page__toc-footer">
                            
                            
                            <p><a href="#top"><strong>Back to top</strong></a></p>
                        </div>

                    </div>

                </div>

                <div class="qe-page__header">

                    <div class="qe-page__header-copy">

                        <p class="qe-page__header-heading"><a href="../index.html">QuantEcon DataScience</a></p>

                        <p class="qe-page__header-subheading">GroupBy</p>

                    </div>

                    <p class="qe-page__header-authors">Chase Coleman, Spencer Lyon, and Jesse Perla</p>

                </div> <!-- .page__header -->



                
                <main class="qe-page__content" role="main">
                    
                    <div>
                        
  <section class="tex2jax_ignore mathjax_ignore" id="groupby">
<h1>GroupBy<a class="headerlink" href="#groupby" title="Permalink to this heading">#</a></h1>
<p><strong>Prerequisites</strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="../python_fundamentals/functions.html"><span class="doc">Functions</span></a></p></li>
<li><p>pandas introduction <a class="reference internal" href="intro.html"><span class="doc">1</span></a> and <a class="reference internal" href="basics.html"><span class="doc">2</span></a></p></li>
<li><p><a class="reference internal" href="reshape.html"><span class="doc">Reshape</span></a></p></li>
</ul>
<p><strong>Outcomes</strong></p>
<ul class="simple">
<li><p>Understand the split-apply-combine strategy for aggregate
computations on groups of data</p></li>
<li><p>Be able use basic aggregation methods on <code class="docutils literal notranslate"><span class="pre">df.groupby</span></code> to compute
within group statistics</p></li>
<li><p>Understand how to group by multiple keys at once</p></li>
</ul>
<p><strong>Data</strong></p>
<ul class="simple">
<li><p>Details for all delayed US domestic flights in December 2016,
obtained from the <a class="reference external" href="https://www.transtats.bts.gov/OT_Delay/OT_DelayCause1.asp">Bureau of Transportation
Statistics</a></p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Uncomment following line to install on colab</span>
<span class="c1">#! pip install </span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
<section id="split-apply-combine">
<h2>Split-Apply-Combine<a class="headerlink" href="#split-apply-combine" title="Permalink to this heading">#</a></h2>
<p>One powerful paradigm for analyzing data is the “Split-Apply-Combine”
strategy.</p>
<p>This strategy has three steps:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Split</span></code>: split the data into groups based on values in one or more columns.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Apply</span></code>: apply a function or routine to each group separately.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Combine</span></code>: combine the output of the apply step into a DataFrame,
using the group identifiers as the index.</p></li>
</ol>
<p>We will cover the main components in this lecture, but we encourage you
to also study the <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/groupby.html">official
documentation</a>
to learn more about what is possible.</p>
<p>To describe the concepts, we will need some data.</p>
<p>We will begin with a simple made-up dataset to discuss the concepts and
then work through extended example and exercises with real data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">C</span><span class="p">[[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s2">&quot;A&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="s2">&quot;B&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="n">C</span><span class="p">,</span>
<span class="p">})</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>A</th>
      <th>B</th>
      <th>C</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>1</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>2</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2</td>
      <td>2</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2</td>
      <td>1</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2</td>
      <td>1</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<section id="simple-example">
<h3>Simple Example<a class="headerlink" href="#simple-example" title="Permalink to this heading">#</a></h3>
<p>To perform the <em>Split</em> step, we call the <code class="docutils literal notranslate"><span class="pre">groupby</span></code> method on our
DataFrame.</p>
<p>The first argument to <code class="docutils literal notranslate"><span class="pre">groupby</span></code> is a description of how we want to
construct groups.</p>
<p>In the most basic version, we will pass a string identifying the column
name.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gbA</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">type</span></code> of variable we get back is a <code class="docutils literal notranslate"><span class="pre">DataFrameGroupBy</span></code>, which we
will sometimes refer to as GroupBy for short.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="n">gbA</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>pandas.core.groupby.generic.DataFrameGroupBy
</pre></div>
</div>
</div>
</div>
<p>Looking at the “groups” inside of the GroupBy object can help us
understand what the GroupBy represents.</p>
<p>We can do this with the <code class="docutils literal notranslate"><span class="pre">gb.get_group(group_name)</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gbA</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>A</th>
      <th>B</th>
      <th>C</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>1</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>2</td>
      <td>3.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gbA</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>A</th>
      <th>B</th>
      <th>C</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3</th>
      <td>2</td>
      <td>2</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2</td>
      <td>1</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2</td>
      <td>1</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can <em>apply</em> some of our favorite aggregation functions directly on the
<code class="docutils literal notranslate"><span class="pre">GroupBy</span></code> object.</p>
<div class="admonition-exercise admonition" id="pd-grp-dir1">
<p class="admonition-title">Exercise</p>
<p>See exercise 1 in the <a class="reference internal" href="#pd-grp-ex"><span class="std std-ref">exercise list</span></a>.</p>
</div>
<div class="admonition-exercise admonition" id="pd-grp-dir2">
<p class="admonition-title">Exercise</p>
<p>See exercise 2 in the <a class="reference internal" href="#pd-grp-ex"><span class="std std-ref">exercise list</span></a>.</p>
</div>
<p>If we pass a list of strings to <code class="docutils literal notranslate"><span class="pre">groupby</span></code>, it will group based on
unique combinations of values from all columns in the list.</p>
<p>Let’s see an example.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gbAB</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">])</span>
<span class="nb">type</span><span class="p">(</span><span class="n">gbAB</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>pandas.core.groupby.generic.DataFrameGroupBy
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gbAB</span><span class="o">.</span><span class="n">get_group</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>A</th>
      <th>B</th>
      <th>C</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>1</td>
      <td>2.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Notice that we still have a GroupBy object, so we can apply our favorite
aggregations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gbAB</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>C</th>
    </tr>
    <tr>
      <th>A</th>
      <th>B</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">1</th>
      <th>1</th>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">2</th>
      <th>1</th>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Notice that the output is a DataFrame with two levels on the index
and a single column <code class="docutils literal notranslate"><span class="pre">C</span></code>. (Quiz: how do we know it is a DataFrame with
one column and not a Series?)</p>
<p>This highlights a principle of how pandas handles the <em>Combine</em> part of
the strategy:</p>
<blockquote>
<div><p>The index of the combined DataFrame will be the group identifiers,
with one index level per group key.</p>
</div></blockquote>
</section>
<section id="custom-aggregate-functions">
<h3>Custom Aggregate Functions<a class="headerlink" href="#custom-aggregate-functions" title="Permalink to this heading">#</a></h3>
<p>So far, we have been applying built-in aggregations to our GroupBy object.</p>
<p>We can also apply custom aggregations to each group of a GroupBy in two
steps:</p>
<ol class="arabic simple">
<li><p>Write our custom aggregation as a Python function.</p></li>
<li><p>Passing our function as an argument to the <code class="docutils literal notranslate"><span class="pre">.agg</span></code> method of a GroupBy.</p></li>
</ol>
<p>Let’s see an example.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">num_missing</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="s2">&quot;Return the number of missing items in each column of df&quot;</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We can call this function on our original DataFrame to get the number of
missing items in each column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_missing</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>A    0
B    0
C    2
dtype: int64
</pre></div>
</div>
</div>
</div>
<p>We can also apply it to a GroupBy object to get the number of missing
items in each column <em>for each group</em>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gbA</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">num_missing</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>B</th>
      <th>C</th>
    </tr>
    <tr>
      <th>A</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The key to keep in mind is that the function we pass to <code class="docutils literal notranslate"><span class="pre">agg</span></code> should
take in a DataFrame (or Series) and return a Series (or single value)
with one item per column in the original DataFrame.</p>
<p>When the function is called, the data for each group will be passed to
our function as a DataFrame (or Series).</p>
</section>
<section id="transforms-the-apply-method">
<h3>Transforms: The <code class="docutils literal notranslate"><span class="pre">apply</span></code> Method<a class="headerlink" href="#transforms-the-apply-method" title="Permalink to this heading">#</a></h3>
<p>As we saw in the <a class="reference internal" href="basics.html"><span class="doc">basics lecture</span></a>, we can apply transforms to DataFrames.</p>
<p>We can do the same with GroupBy objects using the <code class="docutils literal notranslate"><span class="pre">.apply</span></code> method.</p>
<p>Let’s see an example.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>A</th>
      <th>B</th>
      <th>C</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>1</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>2</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2</td>
      <td>2</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2</td>
      <td>1</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2</td>
      <td>1</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">smallest_by_b</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gbA</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">smallest_by_b</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>A</th>
      <th>B</th>
      <th>C</th>
    </tr>
    <tr>
      <th>A</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">1</th>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>1</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">2</th>
      <th>4</th>
      <td>2</td>
      <td>1</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2</td>
      <td>1</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Notice that the return value from applying our series transform to <code class="docutils literal notranslate"><span class="pre">gbA</span></code>
was the group key on the outer level (the <code class="docutils literal notranslate"><span class="pre">A</span></code> column) and the original
index from <code class="docutils literal notranslate"><span class="pre">df</span></code> on the inner level.</p>
<p>The original index came along because that was the index of the
DataFrame returned by <code class="docutils literal notranslate"><span class="pre">smallest_by_b</span></code>.</p>
<p>Had our function returned something other than the index from <code class="docutils literal notranslate"><span class="pre">df</span></code>,
that would appear in the result of the call to <code class="docutils literal notranslate"><span class="pre">.apply</span></code>.</p>
<div class="admonition-exercise admonition" id="pd-grp-dir3">
<p class="admonition-title">Exercise</p>
<p>See exercise 3 in the <a class="reference internal" href="#pd-grp-ex"><span class="std std-ref">exercise list</span></a>.</p>
</div>
</section>
<section id="pd-grouper">
<h3><code class="docutils literal notranslate"><span class="pre">pd.Grouper</span></code><a class="headerlink" href="#pd-grouper" title="Permalink to this heading">#</a></h3>
<p>Sometimes, in order to construct the groups you want, you need to give
pandas more information than just a column name.</p>
<p>Some examples are:</p>
<ul class="simple">
<li><p>Grouping by a column and a level of the index.</p></li>
<li><p>Grouping time series data at a particular frequency.</p></li>
</ul>
<p>pandas lets you do this through the <code class="docutils literal notranslate"><span class="pre">pd.Grouper</span></code> type.</p>
<p>To see it in action, let’s make a copy of <code class="docutils literal notranslate"><span class="pre">df</span></code> with <code class="docutils literal notranslate"><span class="pre">A</span></code> moved to the
index and a <code class="docutils literal notranslate"><span class="pre">Date</span></code> column added.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df2</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span>
    <span class="n">start</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%Y&quot;</span><span class="p">),</span>
    <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;BQ&quot;</span><span class="p">,</span>
    <span class="n">periods</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">df2</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">)</span>
<span class="n">df2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_3411/2961039157.py:3: FutureWarning: The pandas.datetime class is deprecated and will be removed from pandas in a future version. Import from datetime module instead.
  start=pd.datetime.today().strftime(&quot;%m/%d/%Y&quot;),
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>B</th>
      <th>C</th>
      <th>Date</th>
    </tr>
    <tr>
      <th>A</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>1.0</td>
      <td>2023-03-31</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2.0</td>
      <td>2023-06-30</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>3.0</td>
      <td>2023-09-29</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>NaN</td>
      <td>2023-12-29</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>5.0</td>
      <td>2024-03-29</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>NaN</td>
      <td>2024-06-28</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can group by year.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df2</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;A&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>B</th>
      <th>C</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2023-12-31</th>
      <td>4</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2024-12-31</th>
      <td>2</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can group by the <code class="docutils literal notranslate"><span class="pre">A</span></code> level of the index.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df2</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s2">&quot;A&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>B</th>
      <th>C</th>
      <th>Date</th>
    </tr>
    <tr>
      <th>A</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>3</td>
      <td>3</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>1</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can combine these to group by both.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df2</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;A&quot;</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s2">&quot;A&quot;</span><span class="p">)])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>B</th>
      <th>C</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>A</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">2023-12-31</th>
      <th>1</th>
      <td>3</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2024-12-31</th>
      <th>2</th>
      <td>2</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>And we can combine <code class="docutils literal notranslate"><span class="pre">pd.Grouper</span></code> with a string, where the string
denotes a column name</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df2</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;A&quot;</span><span class="p">),</span> <span class="s2">&quot;B&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>C</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>B</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">2023-12-31</th>
      <th>1</th>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
    </tr>
    <tr>
      <th>2024-12-31</th>
      <th>1</th>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
<section id="case-study-airline-delays">
<h2>Case Study: Airline Delays<a class="headerlink" href="#case-study-airline-delays" title="Permalink to this heading">#</a></h2>
<p>Let’s apply our new split-apply-combine skills to the airline dataset we
saw in the <a class="reference internal" href="merge.html"><span class="doc">merge</span></a> lecture.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://datascience.quantecon.org/assets/data/airline_performance_dec16.csv.zip&quot;</span>
<span class="n">air_dec</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">parse_dates</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>First, we compute the average delay in arrival time for all carriers
each week.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">weekly_delays</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">air_dec</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;W&quot;</span><span class="p">),</span> <span class="s2">&quot;Carrier&quot;</span><span class="p">])</span>
    <span class="p">[</span><span class="s2">&quot;ArrDelay&quot;</span><span class="p">]</span>               <span class="c1"># extract one column</span>
    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>                    <span class="c1"># take average</span>
    <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s2">&quot;Carrier&quot;</span><span class="p">)</span>  <span class="c1"># Flip carrier up as column names</span>
<span class="p">)</span>
<span class="n">weekly_delays</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Carrier</th>
      <th>AA</th>
      <th>AS</th>
      <th>B6</th>
      <th>DL</th>
      <th>EV</th>
      <th>F9</th>
      <th>HA</th>
      <th>NK</th>
      <th>OO</th>
      <th>UA</th>
      <th>VX</th>
      <th>WN</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2016-12-04</th>
      <td>-1.714887</td>
      <td>2.724273</td>
      <td>-2.894269</td>
      <td>-5.088351</td>
      <td>8.655332</td>
      <td>-2.894212</td>
      <td>-0.558282</td>
      <td>5.468909</td>
      <td>2.749573</td>
      <td>5.564496</td>
      <td>-2.121821</td>
      <td>-1.663695</td>
    </tr>
    <tr>
      <th>2016-12-11</th>
      <td>1.148833</td>
      <td>12.052031</td>
      <td>5.795062</td>
      <td>2.507745</td>
      <td>13.220673</td>
      <td>4.578861</td>
      <td>2.054302</td>
      <td>8.713755</td>
      <td>15.429660</td>
      <td>4.094176</td>
      <td>12.080938</td>
      <td>1.865933</td>
    </tr>
    <tr>
      <th>2016-12-18</th>
      <td>16.357561</td>
      <td>7.643767</td>
      <td>34.608356</td>
      <td>18.000000</td>
      <td>23.876622</td>
      <td>45.014888</td>
      <td>9.388889</td>
      <td>22.857899</td>
      <td>30.901639</td>
      <td>22.398130</td>
      <td>33.651128</td>
      <td>18.373400</td>
    </tr>
    <tr>
      <th>2016-12-25</th>
      <td>6.364513</td>
      <td>2.719699</td>
      <td>5.586836</td>
      <td>-0.916113</td>
      <td>6.857143</td>
      <td>54.084959</td>
      <td>5.075747</td>
      <td>10.443369</td>
      <td>15.004780</td>
      <td>5.332474</td>
      <td>17.286917</td>
      <td>10.197685</td>
    </tr>
    <tr>
      <th>2017-01-01</th>
      <td>2.321836</td>
      <td>1.226662</td>
      <td>10.661577</td>
      <td>2.048116</td>
      <td>6.800898</td>
      <td>8.280298</td>
      <td>6.970016</td>
      <td>8.361123</td>
      <td>8.971083</td>
      <td>0.061786</td>
      <td>1.349580</td>
      <td>5.213019</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Let’s also plot this data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot</span>
<span class="n">axs</span> <span class="o">=</span> <span class="n">weekly_delays</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">subplots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="c1"># tweak spacing between subplots and xaxis labels</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">weekly_delays</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%a</span><span class="s2">, %b. </span><span class="si">%d</span><span class="s2">&#39;&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ddd4f28b4f8186429e273ac018317542843b8da0cf4e4a5a3eed5e699fa6d428.png" src="../_images/ddd4f28b4f8186429e273ac018317542843b8da0cf4e4a5a3eed5e699fa6d428.png" />
</div>
</div>
<p>It looks like more delays occurred during the week ending Sunday
December 18th than any other week (except for Frontier, who did <em>worse</em>
on Christmas week).</p>
<p>Let’s see why.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">air_dec</span></code> DataFrame has information on the minutes of delay
attributed to 5 different categories:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">delay_cols</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;CarrierDelay&#39;</span><span class="p">,</span>
    <span class="s1">&#39;WeatherDelay&#39;</span><span class="p">,</span>
    <span class="s1">&#39;NASDelay&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SecurityDelay&#39;</span><span class="p">,</span>
    <span class="s1">&#39;LateAircraftDelay&#39;</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s take a quick look at each of those delay categories for the week ending December 18, 2016.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pre_christmas</span> <span class="o">=</span> <span class="n">air_dec</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="p">(</span><span class="n">air_dec</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s2">&quot;2016-12-12&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">air_dec</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="s2">&quot;2016-12-18&quot;</span><span class="p">)</span>
<span class="p">]</span>

<span class="c1"># custom agg function</span>
<span class="k">def</span> <span class="nf">positive</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">df</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="n">delay_totals</span> <span class="o">=</span> <span class="n">pre_christmas</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Carrier&quot;</span><span class="p">)[</span><span class="n">delay_cols</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="n">positive</span><span class="p">])</span>
<span class="n">delay_totals</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="3" halign="left">CarrierDelay</th>
      <th colspan="3" halign="left">WeatherDelay</th>
      <th colspan="3" halign="left">NASDelay</th>
      <th colspan="3" halign="left">SecurityDelay</th>
      <th colspan="3" halign="left">LateAircraftDelay</th>
    </tr>
    <tr>
      <th></th>
      <th>sum</th>
      <th>mean</th>
      <th>positive</th>
      <th>sum</th>
      <th>mean</th>
      <th>positive</th>
      <th>sum</th>
      <th>mean</th>
      <th>positive</th>
      <th>sum</th>
      <th>mean</th>
      <th>positive</th>
      <th>sum</th>
      <th>mean</th>
      <th>positive</th>
    </tr>
    <tr>
      <th>Carrier</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>AA</th>
      <td>105732.0</td>
      <td>6.258553</td>
      <td>2922</td>
      <td>21820.0</td>
      <td>1.291583</td>
      <td>456</td>
      <td>77279.0</td>
      <td>4.574346</td>
      <td>3159</td>
      <td>721.0</td>
      <td>0.042678</td>
      <td>35</td>
      <td>141249.0</td>
      <td>8.360897</td>
      <td>2574</td>
    </tr>
    <tr>
      <th>AS</th>
      <td>8762.0</td>
      <td>2.691032</td>
      <td>250</td>
      <td>3219.0</td>
      <td>0.988636</td>
      <td>61</td>
      <td>16344.0</td>
      <td>5.019656</td>
      <td>614</td>
      <td>163.0</td>
      <td>0.050061</td>
      <td>10</td>
      <td>13599.0</td>
      <td>4.176597</td>
      <td>271</td>
    </tr>
    <tr>
      <th>B6</th>
      <td>49421.0</td>
      <td>9.031615</td>
      <td>1575</td>
      <td>9894.0</td>
      <td>1.808114</td>
      <td>112</td>
      <td>38741.0</td>
      <td>7.079861</td>
      <td>1326</td>
      <td>672.0</td>
      <td>0.122807</td>
      <td>30</td>
      <td>100811.0</td>
      <td>18.423063</td>
      <td>1433</td>
    </tr>
    <tr>
      <th>DL</th>
      <td>151188.0</td>
      <td>8.864212</td>
      <td>2878</td>
      <td>39145.0</td>
      <td>2.295087</td>
      <td>783</td>
      <td>75110.0</td>
      <td>4.403729</td>
      <td>2605</td>
      <td>107.0</td>
      <td>0.006273</td>
      <td>2</td>
      <td>122896.0</td>
      <td>7.205441</td>
      <td>2289</td>
    </tr>
    <tr>
      <th>EV</th>
      <td>87408.0</td>
      <td>9.939504</td>
      <td>1375</td>
      <td>3824.0</td>
      <td>0.434842</td>
      <td>76</td>
      <td>49703.0</td>
      <td>5.651922</td>
      <td>1580</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0</td>
      <td>89773.0</td>
      <td>10.208438</td>
      <td>1568</td>
    </tr>
    <tr>
      <th>F9</th>
      <td>19568.0</td>
      <td>10.430704</td>
      <td>361</td>
      <td>6198.0</td>
      <td>3.303838</td>
      <td>57</td>
      <td>22459.0</td>
      <td>11.971748</td>
      <td>493</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0</td>
      <td>32236.0</td>
      <td>17.183369</td>
      <td>316</td>
    </tr>
    <tr>
      <th>HA</th>
      <td>7199.0</td>
      <td>5.034266</td>
      <td>218</td>
      <td>3650.0</td>
      <td>2.552448</td>
      <td>145</td>
      <td>86.0</td>
      <td>0.060140</td>
      <td>4</td>
      <td>35.0</td>
      <td>0.024476</td>
      <td>3</td>
      <td>4024.0</td>
      <td>2.813986</td>
      <td>189</td>
    </tr>
    <tr>
      <th>NK</th>
      <td>14735.0</td>
      <td>5.294646</td>
      <td>452</td>
      <td>2240.0</td>
      <td>0.804887</td>
      <td>56</td>
      <td>30361.0</td>
      <td>10.909450</td>
      <td>840</td>
      <td>50.0</td>
      <td>0.017966</td>
      <td>5</td>
      <td>22247.0</td>
      <td>7.993891</td>
      <td>372</td>
    </tr>
    <tr>
      <th>OO</th>
      <td>120307.0</td>
      <td>10.439691</td>
      <td>1378</td>
      <td>26349.0</td>
      <td>2.286446</td>
      <td>308</td>
      <td>54141.0</td>
      <td>4.698108</td>
      <td>2289</td>
      <td>171.0</td>
      <td>0.014839</td>
      <td>12</td>
      <td>166102.0</td>
      <td>14.413572</td>
      <td>2459</td>
    </tr>
    <tr>
      <th>UA</th>
      <td>66693.0</td>
      <td>6.312636</td>
      <td>1851</td>
      <td>31602.0</td>
      <td>2.991197</td>
      <td>521</td>
      <td>74992.0</td>
      <td>7.098154</td>
      <td>2065</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0</td>
      <td>118728.0</td>
      <td>11.237861</td>
      <td>1696</td>
    </tr>
    <tr>
      <th>VX</th>
      <td>8048.0</td>
      <td>5.608362</td>
      <td>246</td>
      <td>3807.0</td>
      <td>2.652962</td>
      <td>126</td>
      <td>12619.0</td>
      <td>8.793728</td>
      <td>224</td>
      <td>73.0</td>
      <td>0.050871</td>
      <td>4</td>
      <td>25242.0</td>
      <td>17.590244</td>
      <td>331</td>
    </tr>
    <tr>
      <th>WN</th>
      <td>123882.0</td>
      <td>4.873790</td>
      <td>5393</td>
      <td>23516.0</td>
      <td>0.925171</td>
      <td>328</td>
      <td>78645.0</td>
      <td>3.094067</td>
      <td>4247</td>
      <td>252.0</td>
      <td>0.009914</td>
      <td>18</td>
      <td>285073.0</td>
      <td>11.215399</td>
      <td>6472</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Want</strong>: plot total, average, and number of each type of delay by
carrier</p>
<p>To do this, we need to have a DataFrame with:</p>
<ul class="simple">
<li><p>Delay type in index (so it is on horizontal-axis)</p></li>
<li><p>Aggregation method on <em>outer</em> most level of columns (so we can do
<code class="docutils literal notranslate"><span class="pre">data[&quot;mean&quot;]</span></code> to get averages)</p></li>
<li><p>Carrier name on inner level of columns</p></li>
</ul>
<p>Many sequences of the reshaping commands can accomplish this.</p>
<p>We show one example below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reshaped_delays</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">delay_totals</span>
    <span class="o">.</span><span class="n">stack</span><span class="p">()</span>             <span class="c1"># move aggregation method into index (with Carrier)</span>
    <span class="o">.</span><span class="n">T</span>                   <span class="c1"># put delay type in index and Carrier+agg in column</span>
    <span class="o">.</span><span class="n">swaplevel</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># make agg method outer level of column label</span>
    <span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># sort column labels so it prints nicely</span>
<span class="p">)</span>
<span class="n">reshaped_delays</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="10" halign="left">mean</th>
      <th>...</th>
      <th colspan="10" halign="left">sum</th>
    </tr>
    <tr>
      <th>Carrier</th>
      <th>AA</th>
      <th>AS</th>
      <th>B6</th>
      <th>DL</th>
      <th>EV</th>
      <th>F9</th>
      <th>HA</th>
      <th>NK</th>
      <th>OO</th>
      <th>UA</th>
      <th>...</th>
      <th>B6</th>
      <th>DL</th>
      <th>EV</th>
      <th>F9</th>
      <th>HA</th>
      <th>NK</th>
      <th>OO</th>
      <th>UA</th>
      <th>VX</th>
      <th>WN</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>CarrierDelay</th>
      <td>6.258553</td>
      <td>2.691032</td>
      <td>9.031615</td>
      <td>8.864212</td>
      <td>9.939504</td>
      <td>10.430704</td>
      <td>5.034266</td>
      <td>5.294646</td>
      <td>10.439691</td>
      <td>6.312636</td>
      <td>...</td>
      <td>49421.0</td>
      <td>151188.0</td>
      <td>87408.0</td>
      <td>19568.0</td>
      <td>7199.0</td>
      <td>14735.0</td>
      <td>120307.0</td>
      <td>66693.0</td>
      <td>8048.0</td>
      <td>123882.0</td>
    </tr>
    <tr>
      <th>WeatherDelay</th>
      <td>1.291583</td>
      <td>0.988636</td>
      <td>1.808114</td>
      <td>2.295087</td>
      <td>0.434842</td>
      <td>3.303838</td>
      <td>2.552448</td>
      <td>0.804887</td>
      <td>2.286446</td>
      <td>2.991197</td>
      <td>...</td>
      <td>9894.0</td>
      <td>39145.0</td>
      <td>3824.0</td>
      <td>6198.0</td>
      <td>3650.0</td>
      <td>2240.0</td>
      <td>26349.0</td>
      <td>31602.0</td>
      <td>3807.0</td>
      <td>23516.0</td>
    </tr>
    <tr>
      <th>NASDelay</th>
      <td>4.574346</td>
      <td>5.019656</td>
      <td>7.079861</td>
      <td>4.403729</td>
      <td>5.651922</td>
      <td>11.971748</td>
      <td>0.060140</td>
      <td>10.909450</td>
      <td>4.698108</td>
      <td>7.098154</td>
      <td>...</td>
      <td>38741.0</td>
      <td>75110.0</td>
      <td>49703.0</td>
      <td>22459.0</td>
      <td>86.0</td>
      <td>30361.0</td>
      <td>54141.0</td>
      <td>74992.0</td>
      <td>12619.0</td>
      <td>78645.0</td>
    </tr>
    <tr>
      <th>SecurityDelay</th>
      <td>0.042678</td>
      <td>0.050061</td>
      <td>0.122807</td>
      <td>0.006273</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.024476</td>
      <td>0.017966</td>
      <td>0.014839</td>
      <td>0.000000</td>
      <td>...</td>
      <td>672.0</td>
      <td>107.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>35.0</td>
      <td>50.0</td>
      <td>171.0</td>
      <td>0.0</td>
      <td>73.0</td>
      <td>252.0</td>
    </tr>
    <tr>
      <th>LateAircraftDelay</th>
      <td>8.360897</td>
      <td>4.176597</td>
      <td>18.423063</td>
      <td>7.205441</td>
      <td>10.208438</td>
      <td>17.183369</td>
      <td>2.813986</td>
      <td>7.993891</td>
      <td>14.413572</td>
      <td>11.237861</td>
      <td>...</td>
      <td>100811.0</td>
      <td>122896.0</td>
      <td>89773.0</td>
      <td>32236.0</td>
      <td>4024.0</td>
      <td>22247.0</td>
      <td>166102.0</td>
      <td>118728.0</td>
      <td>25242.0</td>
      <td>285073.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 36 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">agg</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;positive&quot;</span><span class="p">]:</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="n">reshaped_delays</span><span class="p">[</span><span class="n">agg</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">subplots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">agg</span><span class="p">)</span>
<span class="c1">#     fig.tight_layout();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/0d614d872d772efa7c0e36eeecb203efbc9750baa83a2804e8f5dd609cb250ac.png" src="../_images/0d614d872d772efa7c0e36eeecb203efbc9750baa83a2804e8f5dd609cb250ac.png" />
<img alt="../_images/fa645cda0e368b482f08ccab0e8acc617506736e0f1a375b040a214176be4877.png" src="../_images/fa645cda0e368b482f08ccab0e8acc617506736e0f1a375b040a214176be4877.png" />
<img alt="../_images/67c27e889107f3dbd672b9903267bb9b47c206fbfde8781f7c8f7ccf43712cdd.png" src="../_images/67c27e889107f3dbd672b9903267bb9b47c206fbfde8781f7c8f7ccf43712cdd.png" />
</div>
</div>
<div class="admonition-exercise admonition" id="pd-grp-dir4">
<p class="admonition-title">Exercise</p>
<p>See exercise 4 in the <a class="reference internal" href="#pd-grp-ex"><span class="std std-ref">exercise list</span></a>.</p>
</div>
<p>Let’s summarize what we did:</p>
<ul class="simple">
<li><p>Computed average flight delay for each airline for each week.</p></li>
<li><p>Noticed that one week had more delays for all airlines.</p></li>
<li><p>Studied the flights in that week to determine the <em>cause</em> of the
delays in that week.</p></li>
</ul>
<p>Suppose now that we want to repeat that analysis, but at a daily
frequency instead of weekly.</p>
<p>We could copy/paste the code from above and change the <code class="docutils literal notranslate"><span class="pre">W</span></code> to a <code class="docutils literal notranslate"><span class="pre">D</span></code>,
but there’s a better way…</p>
<p>Let’s convert the steps above into two functions:</p>
<ol class="arabic simple">
<li><p>Produce the set of bar charts for average delays at each frequency.</p></li>
<li><p>Produce the second set of charts for the total, average, and number
of occurrences of each type of delay.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mean_delay_plot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make a bar chart of average flight delays for each carrier at</span>
<span class="sd">    a given frequency.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mean_delays</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">),</span> <span class="s2">&quot;Carrier&quot;</span><span class="p">])</span>
        <span class="p">[</span><span class="s2">&quot;ArrDelay&quot;</span><span class="p">]</span>               <span class="c1"># extract one column</span>
        <span class="o">.</span><span class="n">mean</span><span class="p">()</span>                    <span class="c1"># take average</span>
        <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s2">&quot;Carrier&quot;</span><span class="p">)</span>  <span class="c1"># Flip carrier up as column names</span>
    <span class="p">)</span>

    <span class="c1"># plot</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="n">mean_delays</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
        <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">subplots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="c1"># tweak spacing between subplots and x-axis labels</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">mean_delays</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%a</span><span class="s2">, %b. </span><span class="si">%d</span><span class="s2">&#39;&quot;</span><span class="p">))</span>

    <span class="c1"># return the axes in case we want to further tweak the plot outside the function</span>
    <span class="k">return</span> <span class="n">axs</span>


<span class="k">def</span> <span class="nf">delay_type_plot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make bar charts for total minutes, average minutes, and number of</span>
<span class="sd">    occurrences for each delay type, for all flights that were scheduled</span>
<span class="sd">    between `start` date and `end` date</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sub_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">positive</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">df</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">aggs</span> <span class="o">=</span> <span class="n">sub_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Carrier&quot;</span><span class="p">)[</span><span class="n">delay_cols</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="n">positive</span><span class="p">])</span>

    <span class="n">reshaped</span> <span class="o">=</span> <span class="n">aggs</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">agg</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;positive&quot;</span><span class="p">]:</span>
        <span class="n">axs</span> <span class="o">=</span> <span class="n">reshaped</span><span class="p">[</span><span class="n">agg</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">subplots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">agg</span><span class="p">)</span>
<span class="c1">#         fig.tight_layout();</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition-exercise admonition" id="pd-grp-dir5">
<p class="admonition-title">Exercise</p>
<p>See exercise 5 in the <a class="reference internal" href="#pd-grp-ex"><span class="std std-ref">exercise list</span></a>.</p>
</div>
<p>Now let’s look at that plot at a daily frequency. (Note that we need the
figure to be a bit wider in order to see the dates.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean_delay_plot</span><span class="p">(</span><span class="n">air_dec</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f75d64f705bdbb5a0b9f89c6d08bb9f949d49bb74e267121eff96bb1d670a477.png" src="../_images/f75d64f705bdbb5a0b9f89c6d08bb9f949d49bb74e267121eff96bb1d670a477.png" />
</div>
</div>
<p>As we expected given our analysis above, the longest average delays
seemed to happen in the third week.</p>
<p>In particular, it looks like December 17th and 18th had — on average —
higher delays than other days in December.</p>
<p>Let’s use the <code class="docutils literal notranslate"><span class="pre">delay_type_plot</span></code> function to determine the cause of the
delays on those two days.</p>
<p>Because our analysis is captured in a single function, we can look at
the days together and separately without much effort.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># both days</span>
<span class="n">delay_type_plot</span><span class="p">(</span><span class="n">air_dec</span><span class="p">,</span> <span class="s2">&quot;12-17-16&quot;</span><span class="p">,</span> <span class="s2">&quot;12-18-16&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/deda128cc7b1ccfa954dea94b3dfdf417852c8598633da9fbc717e256485e25d.png" src="../_images/deda128cc7b1ccfa954dea94b3dfdf417852c8598633da9fbc717e256485e25d.png" />
<img alt="../_images/1a5e2a9641ea6a87707351cbe5a46ab0293a9391e2de9157d5d2fa671b11ec54.png" src="../_images/1a5e2a9641ea6a87707351cbe5a46ab0293a9391e2de9157d5d2fa671b11ec54.png" />
<img alt="../_images/24b72a0cc89f96bc0065a238127f3cec3de1268119e8424510fffea76e4b5280.png" src="../_images/24b72a0cc89f96bc0065a238127f3cec3de1268119e8424510fffea76e4b5280.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># only the 17th</span>
<span class="n">delay_type_plot</span><span class="p">(</span><span class="n">air_dec</span><span class="p">,</span> <span class="s2">&quot;12-17-16&quot;</span><span class="p">,</span> <span class="s2">&quot;12-17-16&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1e2eb1d6d799a3f143efd962e200669549f43b2a6a489e3c109bf05063aa744d.png" src="../_images/1e2eb1d6d799a3f143efd962e200669549f43b2a6a489e3c109bf05063aa744d.png" />
<img alt="../_images/587c3f2d80b27a1719961a23303402575d92e946c5fc884eff844ed0d0199512.png" src="../_images/587c3f2d80b27a1719961a23303402575d92e946c5fc884eff844ed0d0199512.png" />
<img alt="../_images/1f9d0647a22b576398bfb042ac95197a61c4a9e162152c574390bfe204bce889.png" src="../_images/1f9d0647a22b576398bfb042ac95197a61c4a9e162152c574390bfe204bce889.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># only the 18th</span>
<span class="n">delay_type_plot</span><span class="p">(</span><span class="n">air_dec</span><span class="p">,</span> <span class="s2">&quot;12-18-16&quot;</span><span class="p">,</span> <span class="s2">&quot;12-18-16&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/48eb4b57433ab1bfeba6f8210a54f33ab40ea35b597a851548513eac43e94d6d.png" src="../_images/48eb4b57433ab1bfeba6f8210a54f33ab40ea35b597a851548513eac43e94d6d.png" />
<img alt="../_images/f9aecd4a7ded5a0ed1f18784b3a827c60ee205b0a806a53ba006a3c71784392e.png" src="../_images/f9aecd4a7ded5a0ed1f18784b3a827c60ee205b0a806a53ba006a3c71784392e.png" />
<img alt="../_images/73cf470e9fe085973dbf32252e6d6b4f9d024679793d8b6c5c4de2454084d6ec.png" src="../_images/73cf470e9fe085973dbf32252e6d6b4f9d024679793d8b6c5c4de2454084d6ec.png" />
</div>
</div>
<p>The purpose of this exercise was to drive home the ability to <em>automate</em>
tasks.</p>
<p>We were able to write a pair of <code class="docutils literal notranslate"><span class="pre">functions</span></code> that allows us to easily
repeat the exact same analysis on different subsets of the data, or
different datasets entirely (e.g. we could do the same analysis on
November 2016 data, with two lines of code).</p>
<p>These principles can be applied in many settings.</p>
<p>Keep that in mind as we work through the rest of the materials.</p>
</section>
<section id="exercise-cohort-analysis-using-shopify-data">
<h2>Exercise: Cohort Analysis using Shopify Data<a class="headerlink" href="#exercise-cohort-analysis-using-shopify-data" title="Permalink to this heading">#</a></h2>
<p>The code below will employ a fairly large simulated data set that has the
properties of a order-detail report from <a class="reference external" href="https://www.shopify.com/">Shopify</a>.</p>
<p>We’ll first look at the data, and then describe the exercise</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set the &quot;randomness&quot; seeds</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://datascience.quantecon.org/assets/data/shopify_orders.csv.zip&quot;</span>
<span class="n">orders</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">orders</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>

<span class="n">orders</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 715449 entries, 0 to 715448
Data columns (total 15 columns):
 #   Column             Non-Null Count   Dtype  
---  ------             --------------   -----  
 0   Unnamed: 0         715449 non-null  int64  
 1   Day                715449 non-null  object 
 2   customer_type      715449 non-null  object 
 3   Customer ID        715449 non-null  int64  
 4   orders             715449 non-null  int64  
 5   total_sales        715449 non-null  float64
 6   Returns            715449 non-null  float64
 7   Ordered quantity   715449 non-null  int64  
 8   Gross sales        715449 non-null  float64
 9   Net sales          715449 non-null  float64
 10  Shipping           715449 non-null  float64
 11  Tax                715449 non-null  float64
 12  Net quantity       715449 non-null  int64  
 13  Returned quantity  715449 non-null  int64  
 14  Discounts          715449 non-null  float64
dtypes: float64(7), int64(6), object(2)
memory usage: 81.9+ MB
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>Day</th>
      <th>customer_type</th>
      <th>Customer ID</th>
      <th>orders</th>
      <th>total_sales</th>
      <th>Returns</th>
      <th>Ordered quantity</th>
      <th>Gross sales</th>
      <th>Net sales</th>
      <th>Shipping</th>
      <th>Tax</th>
      <th>Net quantity</th>
      <th>Returned quantity</th>
      <th>Discounts</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>2019-06-17</td>
      <td>Returning</td>
      <td>6535260</td>
      <td>1</td>
      <td>41.03</td>
      <td>-0.0</td>
      <td>1</td>
      <td>41.03</td>
      <td>41.03</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
      <td>-0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2015-01-31</td>
      <td>First-time</td>
      <td>4283889</td>
      <td>1</td>
      <td>37.96</td>
      <td>-0.0</td>
      <td>2</td>
      <td>37.96</td>
      <td>37.96</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>2</td>
      <td>0</td>
      <td>-0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>2017-09-14</td>
      <td>Returning</td>
      <td>5270434</td>
      <td>1</td>
      <td>-25.40</td>
      <td>-30.5</td>
      <td>0</td>
      <td>0.00</td>
      <td>-30.50</td>
      <td>5.09</td>
      <td>0.0</td>
      <td>2</td>
      <td>2</td>
      <td>-0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>2017-10-29</td>
      <td>Returning</td>
      <td>4836086</td>
      <td>1</td>
      <td>12.70</td>
      <td>-0.0</td>
      <td>4</td>
      <td>12.70</td>
      <td>12.70</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>4</td>
      <td>0</td>
      <td>-0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>2016-10-01</td>
      <td>Returning</td>
      <td>9541330</td>
      <td>1</td>
      <td>216.58</td>
      <td>-0.0</td>
      <td>3</td>
      <td>208.59</td>
      <td>208.59</td>
      <td>7.99</td>
      <td>0.0</td>
      <td>3</td>
      <td>0</td>
      <td>-0.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We define a customer’s cohort as the month in which a customer placed
their first order and the customer type as an indicator of whether this
was their first order or a returning order.</p>
<p>We now describe the <em>want</em> for the exercise, which we ask you to
complete.</p>
<p><strong>Want</strong>: Compute the monthly total number of orders, total sales, and
total quantity separated by customer cohort and customer type.</p>
<p>Read that carefully one more time…</p>
<section id="extended-exercise">
<h3>Extended Exercise<a class="headerlink" href="#extended-exercise" title="Permalink to this heading">#</a></h3>
<p>Using the reshape and <code class="docutils literal notranslate"><span class="pre">groupby</span></code> tools you have learned, apply the want
operator described above.</p>
<p>See below for advice on how to proceed.</p>
<p>When you are finished, you should have something that looks like this:</p>
<figure class="align-default">
<img alt="groupby\_cohort\_analysis\_exercise\_output.png" src="../_images/groupby_cohort_analysis_exercise_output.png" />
</figure>
<p>Two notes on the table above:</p>
<p>Your actual output will be much bigger. This is just to give you an
: idea of what it might look like.</p>
<p>The numbers you produce should actually be the same as what are
: included in this table… Index into your answer and compare what you
have with this table to verify your progress.</p>
<p>Now, how to do it?</p>
<p>There is more than one way to code this, but here are some suggested
steps.</p>
<ol class="arabic">
<li><p>Convert the <code class="docutils literal notranslate"><span class="pre">Day</span></code> column to have a <code class="docutils literal notranslate"><span class="pre">datetime</span></code> <code class="docutils literal notranslate"><span class="pre">dtype</span></code> instead
of object.</p>
<ul>
<li><div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Use the <code class="docutils literal notranslate"><span class="pre">pd.to_datetime</span></code> function.</p>
</div>
</li>
</ul>
</li>
<li><p>Add a new column that specifies the date associated with each
customer’s <code class="docutils literal notranslate"><span class="pre">&quot;First-time&quot;</span></code> order.</p>
<ul>
<li><div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>You can do this with a combination of <code class="docutils literal notranslate"><span class="pre">groupby</span></code> and
<code class="docutils literal notranslate"><span class="pre">join</span></code>.</p>
</div>
</li>
<li><div class="admonition hint">
<p class="admonition-title">Hint</p>
<p><code class="docutils literal notranslate"><span class="pre">customer_type</span></code> is always one of <code class="docutils literal notranslate"><span class="pre">Returning</span></code> and <code class="docutils literal notranslate"><span class="pre">First-time</span></code>.</p>
</div>
</li>
<li><div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Some customers don’t have a <code class="docutils literal notranslate"><span class="pre">customer_type</span> <span class="pre">==</span> <span class="pre">&quot;First-time&quot;</span></code> entry. You will need to set the
value for these users to some date that precedes the dates in the
sample. After adding valid data back into <code class="docutils literal notranslate"><span class="pre">orders</span></code> DataFrame,
you can identify which customers don’t have a <code class="docutils literal notranslate"><span class="pre">&quot;First-Time&quot;</span></code>
entry by checking for missing data in the new column.</p>
</div>
</li>
</ul>
</li>
<li><p>You’ll need to group by 3 things.</p></li>
<li><p>You can apply one of the built-in aggregation functions to the GroupBy.</p></li>
<li><p>After doing the aggregation, you’ll need to use your reshaping skills to
move things to the right place in rows and columns.</p></li>
</ol>
<p>Good luck!</p>
</section>
</section>
<section id="exercises">
<span id="pd-grp-ex"></span><h2>Exercises<a class="headerlink" href="#exercises" title="Permalink to this heading">#</a></h2>
<section id="exercise-1">
<h3>Exercise 1<a class="headerlink" href="#exercise-1" title="Permalink to this heading">#</a></h3>
<p>Look closely at the output of the cells below.</p>
<p>How did pandas compute the sum of <code class="docutils literal notranslate"><span class="pre">gbA</span></code>? What happened to the <code class="docutils literal notranslate"><span class="pre">NaN</span></code>
entries in column <code class="docutils literal notranslate"><span class="pre">C</span></code>?</p>
<p>Write your thoughts.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Try <code class="docutils literal notranslate"><span class="pre">gbA.count()</span></code> or <code class="docutils literal notranslate"><span class="pre">gbA.mean()</span></code> if you can’t decide what
happened to the <code class="docutils literal notranslate"><span class="pre">NaN</span></code>.</p>
</div>
<div class="cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gbA</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>(<a class="reference internal" href="#pd-grp-dir1"><span class="std std-ref">back to text</span></a>)</p>
</section>
<section id="exercise-2">
<h3>Exercise 2<a class="headerlink" href="#exercise-2" title="Permalink to this heading">#</a></h3>
<p>Use introspection (tab completion) to see what other aggregations are
defined for GroupBy objects.</p>
<p>Pick three and evaluate them in the cells below.</p>
<p>Does the output of each of these commands have the same features as the
output of <code class="docutils literal notranslate"><span class="pre">gbA.sum()</span></code> from above? If not, what is different?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># method 1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># method 2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># method 3</span>
</pre></div>
</div>
</div>
</div>
<p>(<a class="reference internal" href="#pd-grp-dir2"><span class="std std-ref">back to text</span></a>)</p>
</section>
<section id="exercise-3">
<h3>Exercise 3<a class="headerlink" href="#exercise-3" title="Permalink to this heading">#</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This exercise has a few steps:</p>
</div>
<ol class="arabic">
<li><p>Write a function that, given a DataFrame, computes each entry’s
deviation from the mean of its column.</p></li>
<li><p>Apply the function to <code class="docutils literal notranslate"><span class="pre">gbA</span></code>.</p></li>
<li><p>With your neighbor describe what the index and and columns are? Where
are the group keys (the <code class="docutils literal notranslate"><span class="pre">A</span></code> column)?</p></li>
<li><p>Determine the correct way to add these results back into <code class="docutils literal notranslate"><span class="pre">df</span></code> as
new columns.</p>
<ul>
<li><div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Remember the <a class="reference internal" href="merge.html"><span class="doc">merge</span></a> lecture.</p>
</div>
</li>
</ul>
</li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># write function here</span>


<span class="c1"># apply function here</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># add output of function as new columns to df here...</span>
</pre></div>
</div>
</div>
</div>
<p>Note that if the group keys remained in the index as the <code class="docutils literal notranslate"><span class="pre">.apply</span></code>’s output, the merge/join step would have been complicated.</p>
<p>(<a class="reference internal" href="#pd-grp-dir3"><span class="std std-ref">back to text</span></a>)</p>
</section>
<section id="exercise-4">
<h3>Exercise 4<a class="headerlink" href="#exercise-4" title="Permalink to this heading">#</a></h3>
<p>Think about what is shown in the the plots above.</p>
<p>Answer questions like:</p>
<ul class="simple">
<li><p>Which type of delay was the most common?</p></li>
<li><p>Which one caused the largest average delay?</p></li>
<li><p>Does that vary by airline?</p></li>
</ul>
<p>Write your thoughts.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># your code here if needed</span>
</pre></div>
</div>
</div>
</div>
<p>(<a class="reference internal" href="#pd-grp-dir4"><span class="std std-ref">back to text</span></a>)</p>
</section>
<section id="exercise-5">
<h3>Exercise 5<a class="headerlink" href="#exercise-5" title="Permalink to this heading">#</a></h3>
<p>Verify that we wrote the functions properly by setting the arguments to
appropriate values to replicate the plots from above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># call mean_delay_plot here</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># call delay_type_plot here</span>
</pre></div>
</div>
</div>
</div>
<p>(<a class="reference internal" href="#pd-grp-dir5"><span class="std std-ref">back to text</span></a>)</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./pandas"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                    </div>
                    
                </main> <!-- .page__content -->
                


                <footer class="qe-page__footer">

                    <p><a href="https://creativecommons.org/licenses/by-sa/4.0/"><img src="https://licensebuttons.net/l/by-sa/4.0/80x15.png"></a></p>

                    <p>Creative Commons License &ndash; This work is licensed under a Creative Commons Attribution-ShareAlike 4.0 International.</p>

                </footer> <!-- .page__footer -->

            </div> <!-- .page -->

            

            
            <div class="qe-sidebar bd-sidebar inactive persistent" id="site-navigation">

                <div class="qe-sidebar__header">


                    Contents

                </div>

                <nav class="qe-sidebar__nav" id="qe-sidebar-nav" aria-label="Main navigation">
                    <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Introduction
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/index.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/overview.html">
   Course Description
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/getting_started.html">
   Getting Started
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/cloud_setup.html">
   Cloud Setup
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/local_install.html">
   Local Installation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/troubleshooting.html">
   Troubleshooting
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Python Fundamentals
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../python_fundamentals/index.html">
   Python Fundamentals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../python_fundamentals/basics.html">
   Basics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../python_fundamentals/collections.html">
   Collections
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../python_fundamentals/control_flow.html">
   Control Flow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../python_fundamentals/functions.html">
   Functions
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Scientific Computing
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../scientific/index.html">
   Scientific Computing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../scientific/numpy_arrays.html">
   Introduction to Numpy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../scientific/plotting.html">
   Plotting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../scientific/applied_linalg.html">
   Applied Linear Algebra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../scientific/randomness.html">
   Randomness
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../scientific/optimization.html">
   Optimization
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Pandas
 </span>
</p>
<ul class="current nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="index.html">
   pandas
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="basics.html">
   Basic Functionality
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="the_index.html">
   The Index
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="storage_formats.html">
   Storage Formats
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="data_clean.html">
   Cleaning Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="reshape.html">
   Reshape
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="merge.html">
   Merge
  </a>
 </li>
 <li class="toctree-l1 current active active">
  <a class="current reference internal" href="#">
   GroupBy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="timeseries.html">
   Time series
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="matplotlib.html">
   Intermediate Plotting
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Applications
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../applications/index.html">
   Applications
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../applications/visualization_rules.html">
   Data Visualization: Rules and Guidelines
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../applications/regression.html">
   Regression
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../applications/recidivism.html">
   Case Study: Recidivism
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../applications/maps.html">
   Mapping in Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../applications/classification.html">
   Classification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../applications/working_with_text.html">
   Working with Text
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../applications/ml_in_economics.html">
   Machine Learning in Economics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../applications/heterogeneity.html">
   Heterogeneous Effects
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../applications/networks.html">
   Social and Economic Networks
  </a>
 </li>
</ul>

                </nav>

                <div class="qe-sidebar__footer">

                </div>

            </div> <!-- .sidebar -->
            
        </div> <!-- .main -->

        <div class="qe-toolbar">

            <div class="qe-toolbar__inner">

                <ul class="qe-toolbar__main">
                    <li data-tippy-content="Table of Contents" class="btn__sidebar"><i data-feather="menu"></i></li>
                    <li data-tippy-content="Home"><a href="../index.html"><i data-feather="home"></i></a></li>
                    <li class="btn__qelogo"><a href="https://quantecon.org" title=""><span class="show-for-sr">QuantEcon</span></a></li>
                    <!-- <li class="btn__search">
                        <form action="../search.html" method="get">
                            <input type="search" class="form-control" name="q" id="search-input" placeholder="Search..." aria-label="Search..." autocomplete="off">
                            <i data-feather="search"></i>
                        </form>
                    </li> -->
                </ul>

                <ul class="qe-toolbar__links">
                    <li data-tippy-content="Fullscreen" class="btn__fullscreen"><i data-feather="maximize"></i></li>
                    <li data-tippy-content="Increase font size" class="btn__plus"><i data-feather="plus-circle"></i></li>
                    <li data-tippy-content="Decrease font size" class="btn__minus"><i data-feather="minus-circle"></i></li>
                    <li data-tippy-content="Change contrast" class="btn__contrast"><i data-feather="sunset"></i></li>
                    <li data-tippy-content="Download Notebook"><a href="/_notebooks/pandas/groupby.ipynb" download><i data-feather="download-cloud"></i></a></li>
                    <li class="settings-button" id="settingsButton"><div data-tippy-content="Launch Notebook"><i data-feather="play-circle"></i></div></li>
                        <li data-tippy-content="Download PDF" onClick="window.print()"><i data-feather="file"></i></li>
                    <li data-tippy-content="View Source"><a target="_blank" href="https://github.com/QuantEcon/lecture-datascience.myst/tree/main/lectures/pandas/groupby.md" download><i data-feather="github"></i></a></li>
                </ul>

            </div>

        </div> <!-- .toolbar -->
        <div id="downloadPDFModal" style="display: none;">
            <ul class="pdf-options" style="display: block;">
                <li class="download-pdf-book" onClick="window.print()">
                    <p>Lecture (PDF)</p>
                </li>
                <li class="download-pdf-file">
                    <a href="" download><p>Book (PDF)</p></a>
                </li>
            </ul>
        </div>
        <div id="settingsModal" style="display: none;">
            <p class="modal-title"> Notebook Launcher </p>
            <div class="modal-desc">
            <p>
                Choose public or private cloud service for "Launch" button.
            </p>
            </div>
            <p class="modal-subtitle">Select a server</p>
            <ul class="modal-servers">
            <li class="active launcher-public">
                <span class="label">Public</span>
                <select id="launcher-public-input">
                
                    <option value="https://mybinder.org/v2/gh/QuantEcon/lecture-datascience.notebooks/main?urlpath=tree/pandas/groupby.ipynb">BinderHub</option>
                
                    <option value="https://colab.research.google.com/github/QuantEcon/lecture-datascience.notebooks/blob/main/pandas/groupby.ipynb">Colab</option>
                
                </select>
                <i class="fas fa-check-circle"></i>
            </li>
            <li class="launcher-private">
                <span class="label">Private</span>
                <input type="text" id="launcher-private-input" data-repourl="https://github.com/QuantEcon/lecture-datascience.notebooks" data-urlpath="tree/lecture-datascience.notebooks/pandas/groupby.ipynb" data-branch=main>
                <i class="fas fa-check-circle"></i>
            </li>
            </ul>
            <p class="launch"><a href="https://mybinder.org/v2/gh/QuantEcon/lecture-datascience.notebooks/main?urlpath=tree/pandas/groupby.ipynb" id="advancedLaunchButton" target="_blank">Launch Notebook</a></p>
            <script>
                // QuantEcon Notebook Launcher
                const launcherTypeElements = document.querySelectorAll('#settingsModal .modal-servers li');
                // Highlight the server type if previous selection exists
                if (typeof localStorage.launcherType !== 'undefined') {
                  for (var i = 0; i < launcherTypeElements.length; i++) {
                    launcherTypeElements[i].classList.remove('active');
                    if ( launcherTypeElements[i].classList.contains(localStorage.launcherType) ) {
                      launcherTypeElements[i].classList.add('active');
                    }
                  }
                }
                // Highlight server type on click and set local storage value
                for (var i = 0; i < launcherTypeElements.length; i++) {
                  launcherTypeElements[i].addEventListener('click', function() {
                    for (var j = 0; j < launcherTypeElements.length; j++) {
                      launcherTypeElements[j].classList.remove('active');
                    }
                    this.classList.add('active');
                    if ( this.classList.contains('launcher-private') ) {
                      localStorage.launcherType = 'launcher-private';
                    } else if ( this.classList.contains('launcher-public') ) {
                      localStorage.launcherType = 'launcher-public';
                    }
                    setLaunchServer();
                  })
                }
                const launcherPublic = document.getElementById('launcher-public-input');
                const launcherPrivate = document.getElementById('launcher-private-input');
                const pageName = "pandas/groupby";
                const repoURL = "https://github.com/QuantEcon/lecture-datascience.notebooks";
                const urlPath = "tree/lecture-datascience.notebooks/pandas/groupby.ipynb";
                const branch = "main"
                const launchNotebookLink = document.getElementById('advancedLaunchButton');

                // Highlight public server option if previous selection exists
                if (typeof localStorage.launcherPublic !== 'undefined') {
                  launcherPublic.value = localStorage.launcherPublic;
                }
                // Update local storage upon public server selection
                launcherPublic.addEventListener('change', (event) => {
                  setLaunchServer();
                });
                // Populate private server input if previous entry exists
                if (typeof localStorage.launcherPrivate !== 'undefined') {
                  launcherPrivate.value = localStorage.launcherPrivate;
                }
                // Update local storage when a private server is entered
                launcherPrivate.addEventListener('input', (event) => {
                  setLaunchServer();
                });

                // Function to update the "Launch Notebook" link href
                function setLaunchServer() {
                  launchNotebookLink.removeAttribute("style")
                  if ( localStorage.launcherType == 'launcher-private' ) {
                    let repoPrefix = "/jupyter/hub/user-redirect/git-pull?repo=" + repoURL + "&branch=" + branch + "&urlpath=" + urlPath;
                    launcherPrivateValue = launcherPrivate.value
                    if (!launcherPrivateValue) {
                        launchNotebookLink.removeAttribute("href")
                        launchNotebookLink.style.background = "grey"
                        return
                    }
                    localStorage.launcherPrivate = launcherPrivateValue;
                    privateServer = localStorage.launcherPrivate.replace(/\/$/, "")
                    if (!privateServer.includes("http")) {
                        privateServer = "http://" + privateServer
                    }
                    launchNotebookLinkURL = privateServer + repoPrefix;
                  } else if ( localStorage.launcherType == 'launcher-public' ) {
                    launcherPublicValue = launcherPublic.options[launcherPublic.selectedIndex].value;
                    localStorage.launcherPublic = launcherPublicValue;
                    launchNotebookLinkURL = localStorage.launcherPublic;
                  }
                  if (launchNotebookLinkURL) launchNotebookLink.href = launchNotebookLinkURL;
                }
                // Check if user has previously selected a server
                if ( (typeof localStorage.launcherPrivate !== 'undefined') || (typeof localStorage.launcherPublic !== 'undefined') ) {
                  setLaunchServer();
                }
                </script>

        </div>

    </div> <!-- .wrapper-->
  </body>
</html>