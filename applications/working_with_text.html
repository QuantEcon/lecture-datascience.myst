

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Working with Text &#8212; QuantEcon DataScience</title>
    <script src="https://unpkg.com/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://unpkg.com/tippy.js@6.3.1/dist/tippy-bundle.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    
        <script>
            MathJax = {
            loader: {load: ['[tex]/boldsymbol', '[tex]/textmacros']},
            tex: {
                packages: {'[+]': ['boldsymbol', 'textmacros']},
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                processEscapes: true,
                macros: {
                    "argmax" : "arg\\,max",
                    "argmin" : "arg\\,min",
                    "col"    : "col",
                    "Span"   :  "span",
                    "epsilon": "\\varepsilon",
                    "EE": "\\mathbb{E}",
                    "PP": "\\mathbb{P}",
                    "RR": "\\mathbb{R}",
                    "NN": "\\mathbb{N}",
                    "ZZ": "\\mathbb{Z}",
                    "aA": "\\mathcal{A}",
                    "bB": "\\mathcal{B}",
                    "cC": "\\mathcal{C}",
                    "dD": "\\mathcal{D}",
                    "eE": "\\mathcal{E}",
                    "fF": "\\mathcal{F}",
                    "gG": "\\mathcal{G}",
                    "hH": "\\mathcal{H}",
                }
            },
            svg: {
                fontCache: 'global',
                scale: 0.92,
                displayAlign: "center",
            },
            };
        </script>
    
    
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/quantecon-book-theme.279dae03c5caae754d20501e3fa00bbf.css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/exercise.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d" />


    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script src="../_static/quantecon-book-theme.15b0c36fffe88f468997fa7b698991d3.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-S8CBQPC844"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-S8CBQPC844');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"tex": {"extensions": ["autobold.js"], "macros": {"argmax": "arg\\,max", "argmin": "arg\\,min", "col": "col"}, "processEscapes": true}, "svg": {"scale": "0.92,"}, "options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'applications/working_with_text';</script>
    <link rel="canonical" href="https://datascience.quantecon.org/applications/working_with_text.html" />
    <link rel="shortcut icon" href="../_static/lectures-favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Heterogeneous Effects" href="heterogeneity.html" />
    <link rel="prev" title="Case Study: Recidivism" href="recidivism.html" />

<!-- Normal Meta Tags -->
<meta name="author" context="Chase Coleman, Spencer Lyon, and Jesse Perla" />
<meta name="keywords" content="Python, QuantEcon, DataScience" />
<meta name="description" content=This website presents a series of lectures on programming, data science, and economics. />

<!-- Twitter tags -->
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@quantecon" />
<meta name="twitter:title" content="Working with Text"/>
<meta name="twitter:description" content="This website presents a series of lectures on programming, data science, and economics.">
<meta name="twitter:creator" content="@quantecon">
<meta name="twitter:image" content="https://assets.quantecon.org/img/qe-twitter-logo.png">

<!-- Opengraph tags -->
<meta property="og:title" content="Working with Text" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://datascience.quantecon.org/applications/working_with_text.html" />
<meta property="og:image" content="https://assets.quantecon.org/img/qe-og-logo.png" />
<meta property="og:description" content="This website presents a series of lectures on programming, data science, and economics." />
<meta property="og:site_name" content="QuantEcon DataScience" />
<meta name="theme-color" content="#ffffff" />

  </head>
<body>


    <span id="top"></span>

    <div class="qe-wrapper">

        <div class="qe-main">

            <div class="qe-page" id=applications/working_with_text>

                <div class="qe-page__toc">

                    <div class="inner">

                        
                        <div class="qe-page__toc-header">
                            On this page
                        </div>


                        <nav id="bd-toc-nav" class="qe-page__toc-nav">
                            <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#avalanches">Avalanches</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data">Data</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#incident-data">Incident Data</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#mapping-incidents">Mapping Incidents</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#matching-incidents-to-regions">Matching Incidents to Regions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#forecast-data">Forecast Data</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#predicting-incidents-from-text">Predicting Incidents from Text</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preprocessing">Preprocessing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-engineering">Feature Engineering</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#naive-bayes-classifier">Naive Bayes Classifier</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#unsupervised-learning">Unsupervised Learning</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#latent-semantic-analysis">Latent Semantic Analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#latent-dirichlet-analysis">Latent Dirichlet Analysis</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1">Exercise 1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2">Exercise 2</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3">Exercise 3</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-4">Exercise 4</a></li>
</ul>
</li>
</ul>
                            <p class="logo">
                                
                                    
                                    <a href=https://quantecon.org><img src="../_static/datascience-logo.png" class="logo" alt="logo"></a>
                                    
                                
                            </p>

                            <p class="powered">Powered by <a href="https://jupyterbook.org/">Jupyter Book</a></p>

                        </nav>

                        <div class="qe-page__toc-footer">
                            
                            
                            <p><a href="#top"><strong>Back to top</strong></a></p>
                        </div>

                    </div>

                </div>

                <div class="qe-page__header">

                    <div class="qe-page__header-copy">

                        <p class="qe-page__header-heading"><a href="../index.html">QuantEcon DataScience</a></p>

                        <p class="qe-page__header-subheading">Working with Text</p>

                    </div>

                    <p class="qe-page__header-authors">Chase Coleman, Spencer Lyon, and Jesse Perla</p>

                </div> <!-- .page__header -->



                
                <main class="qe-page__content" role="main">
                    
                    <div>
                        
  <section class="tex2jax_ignore mathjax_ignore" id="working-with-text">
<h1>Working with Text<a class="headerlink" href="#working-with-text" title="Permalink to this heading">#</a></h1>
<p><strong>Author</strong></p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://economics.ubc.ca/faculty-and-staff/paul-schrimpf/">Paul Schrimpf <em>UBC</em></a></p></li>
</ul>
</div></blockquote>
<p><strong>Prerequisites</strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="../tools/visualization_rules.html"><span class="doc">Visualization Rules</span></a></p></li>
<li><p><a class="reference internal" href="../tools/regression.html"><span class="doc">Regression</span></a></p></li>
<li><p><a class="reference internal" href="../tools/classification.html"><span class="doc">Classification</span></a></p></li>
<li><p><a class="reference internal" href="../tools/maps.html"><span class="doc">Maps</span></a></p></li>
</ul>
<p><strong>Outcomes</strong></p>
<ul class="simple">
<li><p>Use text as features for classification</p></li>
<li><p>Understand latent topic analysis</p></li>
<li><p>Use folium to create an interactive map</p></li>
<li><p>Request and combine json data from a web server</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Uncomment following line to install on colab</span>
<span class="c1">#! pip install fiona geopandas xgboost gensim folium pyLDAvis descartes</span>
</pre></div>
</div>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
<p>Many data sources contain both numerical data and text.</p>
<p>We can use text to create features for any of the prediction methods
that we have discussed.</p>
<p>Doing so requires encoding text into some numerical representation.</p>
<p>A good encoding preserves the meaning of the original text, while
keeping dimensionality manageable.</p>
<p>In this lecture, we will learn how to work with text through an
application — predicting fatalities from avalanche
forecasts.</p>
</section>
<section id="avalanches">
<h2>Avalanches<a class="headerlink" href="#avalanches" title="Permalink to this heading">#</a></h2>
<p>Snow avalanches are a hazard in the mountains. Avalanches can be
partially predicted based on snow conditions, weather, and
terrain. <a class="reference external" href="https://www.avalanche.ca/map">Avalanche Canada</a> produces
daily avalanche forecasts for various Canadian mountainous regions.
These forecasts consist of 1-5 ratings for each of three
elevation bands, as well as textual descriptions of recent avalanche
observations, snowpack, and weather. Avalanche Canada also
maintains a list of <a class="reference external" href="https://www.avalanche.ca/incidents/">fatal avalanche incidents</a> . In this lecture, we will
attempt to predict fatal incidents from the text of avalanche
forecasts. Since fatal incidents are rare, this prediction task will
be quite difficult.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>


<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
<section id="data">
<h3>Data<a class="headerlink" href="#data" title="Permalink to this heading">#</a></h3>
<p>Avalanche Canada has an unstable json api. The api seems to be largely
tailored to displaying the information on various Avalanche Canada
websites, which does not make it easy to obtain large amounts of
data. Nonetheless, getting information from the API is easier than
scraping the website. Generally, whenever you’re considering scraping
a website, you should first check whether the site has an API available.</p>
<section id="incident-data">
<h4>Incident Data<a class="headerlink" href="#incident-data" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get data on avalanche forecasts and incidents from Avalanche Canada</span>
<span class="c1"># Avalanche Canada has an unstable public api</span>
<span class="c1"># https://github.com/avalanche-canada/ac-web</span>
<span class="c1"># Since API might change, this code might break</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">warnings</span>


<span class="c1"># Incidents</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://incidents.avalanche.ca/public/incidents/?format=json&quot;</span>
<span class="n">req</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
<span class="n">incident_list</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">]</span>
<span class="k">while</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;next&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;next&quot;</span><span class="p">])</span>
    <span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="n">incident_list</span> <span class="o">=</span> <span class="n">incident_list</span> <span class="o">+</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">]</span>
<span class="n">incidents_brief</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">incident_list</span><span class="p">,</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_rows</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_columns</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">incidents_brief</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>date</th>
      <th>location</th>
      <th>location_province</th>
      <th>group_activity</th>
      <th>num_involved</th>
      <th>num_injured</th>
      <th>num_fatal</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>8ecba312-3821-4039-abc0-369c5b57fecc</td>
      <td>2024-03-29</td>
      <td>Cathedral Mountain</td>
      <td>BC</td>
      <td>Backcountry Skiing</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>eb808585-e664-4517-bedc-c5dfd5f9fc91</td>
      <td>2024-03-26</td>
      <td>La ligne Bleue à la Martre</td>
      <td>QC</td>
      <td>Snow Biking</td>
      <td>4.0</td>
      <td>0.0</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>b531e881-12c4-4559-ba16-eb65e3f3d291</td>
      <td>2024-03-10</td>
      <td>The Tower</td>
      <td>AB</td>
      <td>Backcountry Skiing</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>c91f7f67-ffa3-4a10-814e-c495bef84fb5</td>
      <td>2024-03-03</td>
      <td>Sale Mountain</td>
      <td>BC</td>
      <td>Snow Biking</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>af550688-52ca-4d7f-9da5-2efa2a1d2399</td>
      <td>2024-02-24</td>
      <td>Gardiner Creek</td>
      <td>AB</td>
      <td>Snowmobiling</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>505</th>
      <td>101c517b-29a4-4c49-8934-f6c56ddd882d</td>
      <td>1840-02-01</td>
      <td>Château-Richer</td>
      <td>QC</td>
      <td>Unknown</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1</td>
    </tr>
    <tr>
      <th>506</th>
      <td>b2e1c50a-1533-4145-a1a2-0befca0154d5</td>
      <td>1836-02-09</td>
      <td>Quebec</td>
      <td>QC</td>
      <td>Unknown</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1</td>
    </tr>
    <tr>
      <th>507</th>
      <td>18e8f963-da33-4682-9312-57ca2cc9ad8d</td>
      <td>1833-05-24</td>
      <td>Carbonear</td>
      <td>NL</td>
      <td>Unknown</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>508</th>
      <td>083d22df-ed50-4687-b9ab-1649960a0fbe</td>
      <td>1825-02-04</td>
      <td>Saint-Joseph de Lévis</td>
      <td>QC</td>
      <td>Inside Building</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>5</td>
    </tr>
    <tr>
      <th>509</th>
      <td>f498c48a-981d-43cf-ac16-151b8794435c</td>
      <td>1782-01-01</td>
      <td>Nain</td>
      <td>NL</td>
      <td>Unknown</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>22</td>
    </tr>
  </tbody>
</table>
<p>510 rows × 8 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We can get more information about these incidents e.g. &quot;https://www.avalanche.ca/incidents/37d909e4-c6de-43f1-8416-57a34cd48255&quot;</span>
<span class="c1"># this information is also available through the API</span>
<span class="k">def</span> <span class="nf">get_incident_details</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://incidents.avalanche.ca/public/incidents/</span><span class="si">{}</span><span class="s2">?format=json&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="k">return</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>


<span class="n">incidentsfile</span> <span class="o">=</span> <span class="s2">&quot;https://datascience.quantecon.org/assets/data/avalanche_incidents.csv&quot;</span>

<span class="c1"># To avoid loading the avalanche Canada servers, we save the incident details locally.</span>
<span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">incidentsfile</span><span class="p">)):</span>
    <span class="n">incident_detail_list</span> <span class="o">=</span> <span class="n">incidents_brief</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_incident_details</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="n">incidents</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">incident_detail_list</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>
    <span class="n">incidents</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">incidentsfile</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">incidents</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">incidentsfile</span><span class="p">)</span>

<span class="n">incidents</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>ob_date</th>
      <th>location</th>
      <th>location_desc</th>
      <th>...</th>
      <th>weather_comment</th>
      <th>snowpack_obs</th>
      <th>snowpack_comment</th>
      <th>documents</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>8ecba312-3821-4039-abc0-369c5b57fecc</td>
      <td>2024-03-29</td>
      <td>Cathedral Mountain</td>
      <td>In Yoho National Park, approximately 9 km west...</td>
      <td>...</td>
      <td></td>
      <td>{'hs': None, 'hn24': None, 'hst': None, 'hst_r...</td>
      <td></td>
      <td>[{'date': '2024-04-02', 'title': 'View of the ...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>eb808585-e664-4517-bedc-c5dfd5f9fc91</td>
      <td>2024-03-26</td>
      <td>La ligne Bleue à la Martre</td>
      <td>La Martre valley region</td>
      <td>...</td>
      <td>Weather data comes from the Mont Ernest-Laforc...</td>
      <td>{'hs': None, 'hn24': None, 'hst': None, 'hst_r...</td>
      <td></td>
      <td>[{'date': '2024-03-26', 'title': 'Couronne/Ava...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>b531e881-12c4-4559-ba16-eb65e3f3d291</td>
      <td>2024-03-10</td>
      <td>The Tower</td>
      <td>Within Spray Valley Provincial Park, approxima...</td>
      <td>...</td>
      <td>Weather information taken from Burstall Pass w...</td>
      <td>{'hs': None, 'hn24': None, 'hst': None, 'hst_r...</td>
      <td></td>
      <td>[{'date': '2024-03-11', 'title': 'Overview of ...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>c91f7f67-ffa3-4a10-814e-c495bef84fb5</td>
      <td>2024-03-03</td>
      <td>Sale Mountain</td>
      <td>18 km NE of Revelstoke</td>
      <td>...</td>
      <td></td>
      <td>{'hs': None, 'hn24': None, 'hst': None, 'hst_r...</td>
      <td></td>
      <td>[{'date': '2024-03-03', 'title': 'Sale avalanc...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>af550688-52ca-4d7f-9da5-2efa2a1d2399</td>
      <td>2024-02-24</td>
      <td>Gardiner Creek</td>
      <td>Within Castle Wildland Provincial Park, approx...</td>
      <td>...</td>
      <td>Approximately 8 cm new snow occurred in the mo...</td>
      <td>{'hs': None, 'hn24': None, 'hst': None, 'hst_r...</td>
      <td></td>
      <td>[{'date': '2024-02-25', 'title': 'Overview of ...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>505</th>
      <td>101c517b-29a4-4c49-8934-f6c56ddd882d</td>
      <td>1840-02-01</td>
      <td>Château-Richer</td>
      <td></td>
      <td>...</td>
      <td></td>
      <td>{'hs': None, 'hn24': None, 'hst': None, 'hst_r...</td>
      <td></td>
      <td>[]</td>
    </tr>
    <tr>
      <th>506</th>
      <td>b2e1c50a-1533-4145-a1a2-0befca0154d5</td>
      <td>1836-02-09</td>
      <td>Quebec</td>
      <td>more details unknown</td>
      <td>...</td>
      <td></td>
      <td>{'hs': None, 'hn24': None, 'hst': None, 'hst_r...</td>
      <td></td>
      <td>[]</td>
    </tr>
    <tr>
      <th>507</th>
      <td>18e8f963-da33-4682-9312-57ca2cc9ad8d</td>
      <td>1833-05-24</td>
      <td>Carbonear</td>
      <td></td>
      <td>...</td>
      <td></td>
      <td>{'hs': None, 'hn24': None, 'hst': None, 'hst_r...</td>
      <td></td>
      <td>[{'title': 'Carbonear, May 24, 1833', 'source'...</td>
    </tr>
    <tr>
      <th>508</th>
      <td>083d22df-ed50-4687-b9ab-1649960a0fbe</td>
      <td>1825-02-04</td>
      <td>Saint-Joseph de Lévis</td>
      <td>Pointe Lévis</td>
      <td>...</td>
      <td></td>
      <td>{'hs': None, 'hn24': None, 'hst': None, 'hst_r...</td>
      <td></td>
      <td>[]</td>
    </tr>
    <tr>
      <th>509</th>
      <td>f498c48a-981d-43cf-ac16-151b8794435c</td>
      <td>1782-01-01</td>
      <td>Nain</td>
      <td></td>
      <td>...</td>
      <td></td>
      <td>{'hs': None, 'hn24': None, 'hst': None, 'hst_r...</td>
      <td></td>
      <td>[{'title': 'Nain, 1781-2', 'source': 'NFLD Geo...</td>
    </tr>
  </tbody>
</table>
<p>510 rows × 19 columns</p>
</div></div></div>
</div>
<p>Many incidents include coordinates, but others do not. Most
however, do include a place name. We can use <a class="reference external" href="https://www.nrcan.gc.ca/earth-sciences/geography/topographic-information/geolocalisation-service/17304">Natural Resources Canada’s
Geolocation Service</a>
to retrieve coordinates from place names.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># geocode locations without coordinates</span>
<span class="k">def</span> <span class="nf">geolocate</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">province</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://geogratis.gc.ca/services/geolocation/en/locate?q=</span><span class="si">{}</span><span class="s2">,%20</span><span class="si">{}</span><span class="s2">&quot;</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">location</span><span class="p">),</span><span class="n">province</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="s1">&#39;coordinates&#39;</span><span class="p">])</span>
<span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;alt_coord&quot;</span> <span class="ow">in</span> <span class="n">incidents</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">incidents</span><span class="p">[</span><span class="s2">&quot;alt_coord&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">geolocate</span><span class="p">(</span><span class="n">incidents</span><span class="o">.</span><span class="n">location</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">incidents</span><span class="o">.</span><span class="n">location_province</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">incidents</span><span class="o">.</span><span class="n">index</span>
    <span class="p">]</span>
    <span class="n">incidents</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">incidentsfile</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now that we have incident data, let’s create some figures.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># clean up activity names</span>
<span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([&#39;Backcountry Skiing&#39;, &#39;Snow Biking&#39;, &#39;Snowmobiling&#39;,
       &#39;Ice Climbing&#39;, &#39;Lift Skiing Closed&#39;, &#39;Mechanized Skiing&#39;,
       &#39;Out-of-Bounds Skiing/Snowboarding&#39;, &#39;Mountaineering&#39;,
       &#39;Lift Skiing Open&#39;, &#39;Backcountry Skiing/Snowboarding&#39;,
       &#39;Skiing/Snowboarding&#39;, &#39;Snowshoeing&#39;, &#39;Snowboarding&#39;,
       &#39;Ski touring&#39;, &#39;Skiing&#39;, &#39;Heliskiing&#39;, &#39;Snowshoeing &amp; Hiking&#39;,
       &#39;Work&#39;, &#39;Other Recreational&#39;, &#39;Out-of-bounds Skiing&#39;,
       &#39;At Outdoor Worksite&#39;, &#39;Hunting/Fishing&#39;, &#39;Out-of-Bounds Skiing&#39;,
       &#39;Control Work&#39;, &#39;Inside Building&#39;, &#39;Car/Truck on Road&#39;,
       &#39;Inside Car/Truck on Road&#39;, &#39;Unknown&#39;, &#39;Outside Building&#39;],
      dtype=object)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">=</span><span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Ski touring&quot;</span><span class="p">,</span><span class="s2">&quot;Backcountry Skiing&quot;</span><span class="p">)</span>
<span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">=</span><span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Out-of-Bounds Skiing&quot;</span><span class="p">,</span><span class="s2">&quot;Backcountry Skiing&quot;</span><span class="p">)</span>
<span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">=</span><span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Lift Skiing Closed&quot;</span><span class="p">,</span><span class="s2">&quot;Backcountry Skiing&quot;</span><span class="p">)</span>
<span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">=</span><span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Skiing&quot;</span><span class="p">,</span><span class="s2">&quot;Backcountry Skiing&quot;</span><span class="p">)</span>
<span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">=</span><span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Snowshoeing&quot;</span><span class="p">,</span><span class="s2">&quot;Snowshoeing &amp; Hiking&quot;</span><span class="p">)</span>
<span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">=</span><span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Snowshoeing and Hiking&quot;</span><span class="p">,</span><span class="s2">&quot;Snowshoeing &amp; Hiking&quot;</span><span class="p">)</span>
<span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">=</span><span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Mechanized Skiing&quot;</span><span class="p">,</span><span class="s2">&quot;Heli or Cat Skiing&quot;</span><span class="p">)</span>
<span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">=</span><span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Heliskiing&quot;</span><span class="p">,</span><span class="s2">&quot;Heli or Cat Skiing&quot;</span><span class="p">)</span>
<span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">=</span><span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;At Outdoor Worksite&quot;</span><span class="p">,</span><span class="s2">&quot;Work&quot;</span><span class="p">)</span>
<span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">=</span><span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Control Work&quot;</span><span class="p">,</span><span class="s2">&quot;Work&quot;</span><span class="p">)</span>
<span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">=</span><span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Hunting/Fishing&quot;</span><span class="p">,</span><span class="s2">&quot;Other Recreational&quot;</span><span class="p">)</span>
<span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">=</span><span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Inside Car/Truck on Road&quot;</span><span class="p">,</span><span class="s2">&quot;Car/Truck/Building&quot;</span><span class="p">)</span>
<span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">=</span><span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Car/Truck on Road&quot;</span><span class="p">,</span><span class="s2">&quot;Car/Truck/Building&quot;</span><span class="p">)</span>
<span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">=</span><span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Inside Building&quot;</span><span class="p">,</span><span class="s2">&quot;Car/Truck/Building&quot;</span><span class="p">)</span>
<span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">=</span><span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Outside Building&quot;</span><span class="p">,</span><span class="s2">&quot;Car/Truck/Building&quot;</span><span class="p">)</span>


<span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">colors</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.prop_cycle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">by_key</span><span class="p">()[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>
<span class="n">incidents</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;group_activity&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Incidents by Activity&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">incidents</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;group_activity&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">num_fatal</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Deaths by Activity&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="kc">None</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/3808d8c226a01da27813955c14230ba7e297f727a359bd05879a5987647f99e4.png" src="../_images/3808d8c226a01da27813955c14230ba7e297f727a359bd05879a5987647f99e4.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">incidents</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">incidents</span><span class="o">.</span><span class="n">ob_date</span><span class="p">)</span>
<span class="n">incidents</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">incidents</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
<span class="n">incidents</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="n">incidents</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
<span class="n">colors</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.prop_cycle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">by_key</span><span class="p">()[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">incidents</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;year&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">num_fatal</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">incidents</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;year&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="n">yearstart</span><span class="o">=</span><span class="mi">1950</span>
<span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">index</span><span class="o">&gt;</span><span class="n">yearstart</span><span class="p">]</span>
<span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">index</span><span class="o">&gt;</span><span class="n">yearstart</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">n</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;Incidents&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">2010</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;Deaths&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">2011</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/68f5d6423080834afa89a48aaa6434dee990e31b163fe3e2a40a753d7c86f452.png" src="../_images/68f5d6423080834afa89a48aaa6434dee990e31b163fe3e2a40a753d7c86f452.png" />
</div>
</div>
</section>
<section id="mapping-incidents">
<h4>Mapping Incidents<a class="headerlink" href="#mapping-incidents" title="Permalink to this heading">#</a></h4>
<p>Since the incident data includes coordinates, we might as well make a
map too. Unfortunately, some latitude and longitudes contain obvious errors.
Here, we try to fix them.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>

<span class="c1"># fix errors in latitude, longitude</span>
<span class="n">latlon</span> <span class="o">=</span> <span class="n">incidents</span><span class="o">.</span><span class="n">location_coords</span>
<span class="k">def</span> <span class="nf">makenumeric</span><span class="p">(</span><span class="n">cstr</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">cstr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">])</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">cstr</span><span class="p">)</span><span class="o">==</span><span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;-?\d+\.?\d*&#39;</span><span class="p">,</span><span class="n">cstr</span><span class="p">)])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="n">cstr</span><span class="p">)</span>

<span class="n">latlon</span> <span class="o">=</span> <span class="n">latlon</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">makenumeric</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">good_lat</span><span class="p">(</span><span class="n">lat</span><span class="p">):</span>
    <span class="k">return</span><span class="p">(</span><span class="n">lat</span> <span class="o">&gt;=</span> <span class="mf">41.6</span> <span class="ow">and</span> <span class="n">lat</span> <span class="o">&lt;=</span> <span class="mf">83.12</span><span class="p">)</span> <span class="c1"># min &amp; max for Canada</span>

<span class="k">def</span> <span class="nf">good_lon</span><span class="p">(</span><span class="n">lon</span><span class="p">):</span>
    <span class="k">return</span><span class="p">(</span><span class="n">lon</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">141</span> <span class="ow">and</span> <span class="n">lon</span><span class="o">&lt;=</span> <span class="o">-</span><span class="mf">52.6</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">fixlatlon</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">2</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">!=</span><span class="nb">float</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">!=</span><span class="nb">float</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">return</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">good_lat</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="ow">and</span> <span class="n">good_lat</span><span class="p">(</span><span class="n">lon</span><span class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">lat</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">lon</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">tmp</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">good_lon</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="ow">and</span> <span class="n">good_lon</span><span class="p">(</span><span class="o">-</span><span class="n">lon</span><span class="p">):</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="o">-</span><span class="n">lon</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">good_lon</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="ow">and</span> <span class="n">good_lon</span><span class="p">(</span><span class="n">lat</span><span class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">lat</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">lon</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">tmp</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">good_lon</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="ow">and</span> <span class="n">good_lon</span><span class="p">(</span><span class="o">-</span><span class="n">lat</span><span class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="o">-</span><span class="n">lat</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">lon</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">tmp</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">good_lat</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">good_lon</span><span class="p">(</span><span class="n">lon</span><span class="p">):</span>
        <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat</span>
        <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lon</span>
    <span class="k">return</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

<span class="n">incidents</span><span class="p">[</span><span class="s2">&quot;latlon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">latlon</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">fixlatlon</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">==</span><span class="nb">str</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;-?\d+\.?\d*&#39;</span><span class="p">,</span><span class="n">a</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
    <span class="k">return</span><span class="p">([</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">!=</span><span class="nb">float</span> <span class="k">else</span> <span class="n">c</span><span class="p">)</span>
<span class="n">incidents</span><span class="p">[</span><span class="s2">&quot;latlon_filled&quot;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">foo</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">a</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">incidents</span><span class="p">[</span><span class="s2">&quot;latlon&quot;</span><span class="p">],</span><span class="n">incidents</span><span class="p">[</span><span class="s2">&quot;alt_coord&quot;</span><span class="p">])]</span>
<span class="n">nmiss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="kc">None</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">incidents</span><span class="o">.</span><span class="n">latlon_filled</span><span class="p">])</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">incidents</span><span class="o">.</span><span class="n">latlon_filled</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> of </span><span class="si">{}</span><span class="s2"> incidents have latitude &amp; longitude&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">nmiss</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>140 of 510 incidents have latitude &amp; longitude
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># download forecast region definitions</span>
<span class="c1"># req = urllib.request.Request(&quot;https://www.avalanche.ca/api/forecasts&quot;)</span>
<span class="c1"># The above link doesn&#39;t work since COVID-19 lockdown. Currently we use an old cached version instead</span>
<span class="c1">#req = (&quot;https://web.archive.org/web/20150319031605if_/http://www.avalanche.ca/api/forecasts&quot;)</span>
<span class="c1">#with urllib.request.urlopen(req) as response:</span>
<span class="c1">#    forecastregions = json.loads(response.read().decode(&#39;utf-8&#39;))</span>
<span class="n">req</span> <span class="o">=</span> <span class="s2">&quot;https://faculty.arts.ubc.ca/pschrimpf/forecast-regions2015.json&quot;</span>
<span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
    <span class="n">regions2015</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

<span class="n">req</span> <span class="o">=</span> <span class="s2">&quot;https://faculty.arts.ubc.ca/pschrimpf/forecast-regions2019.json&quot;</span>
<span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
    <span class="n">regions2019</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

<span class="n">forecastregions</span> <span class="o">=</span> <span class="n">regions2019</span>
<span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">forecastregions</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]]</span>
<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">regions2015</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]</span> <span class="p">:</span>
     <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ids</span> <span class="p">:</span>
            <span class="n">forecastregions</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>You may have to uncomment the second line below if  folium is not installed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Map forecast regions and incidents</span>
<span class="c1">#!pip install --user folium</span>
<span class="kn">import</span> <span class="nn">folium</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>

<span class="n">cmap</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;Set1&#39;</span><span class="p">)</span>
<span class="n">fmap</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="o">-</span><span class="mi">98</span><span class="p">],</span>
                            <span class="n">zoom_start</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                            <span class="n">tiles</span><span class="o">=</span><span class="s1">&#39;Stamen Terrain&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
    <span class="n">regions_tmp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
<span class="n">folium</span><span class="o">.</span><span class="n">GeoJson</span><span class="p">(</span><span class="n">regions_tmp</span><span class="p">,</span>
               <span class="n">tooltip</span><span class="o">=</span><span class="n">folium</span><span class="o">.</span><span class="n">GeoJsonTooltip</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">aliases</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]),</span>
               <span class="n">highlight_function</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">{</span> <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
              <span class="n">style_function</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">fmap</span><span class="p">)</span>
<span class="n">activities</span> <span class="o">=</span> <span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">incidents</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">incidents</span><span class="o">.</span><span class="n">latlon_filled</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>  <span class="n">incidents</span><span class="o">.</span><span class="n">latlon_filled</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cindex</span><span class="o">=</span><span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">activities</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">==</span><span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&lt;br&gt;</span><span class="si">{}</span><span class="s2"> deaths&quot;</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">incidents</span><span class="o">.</span><span class="n">group_activity</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">incidents</span><span class="o">.</span><span class="n">ob_date</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">incidents</span><span class="o">.</span><span class="n">num_fatal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="p">)</span>
        <span class="n">pop</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Popup</span><span class="p">(</span><span class="n">incidents</span><span class="o">.</span><span class="n">comment</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">parse_html</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_width</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
        <span class="n">folium</span><span class="o">.</span><span class="n">CircleMarker</span><span class="p">(</span><span class="n">incidents</span><span class="o">.</span><span class="n">latlon_filled</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                      <span class="n">tooltip</span><span class="o">=</span><span class="n">txt</span><span class="p">,</span>
                      <span class="n">popup</span><span class="o">=</span><span class="n">pop</span><span class="p">,</span>
                      <span class="n">color</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">to_hex</span><span class="p">(</span><span class="n">cmap</span><span class="p">(</span><span class="n">cindex</span><span class="p">)),</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">fmap</span><span class="p">)</span>
<span class="n">fmap</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">AttributeError</span><span class="g g-Whitespace">                            </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="n">line</span> <span class="mi">6</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="kn">import</span> <span class="nn">folium</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="ne">----&gt; </span><span class="mi">6</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;Set1&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="n">fmap</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="o">-</span><span class="mi">98</span><span class="p">],</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>                             <span class="n">zoom_start</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span>                             <span class="n">tiles</span><span class="o">=</span><span class="s1">&#39;Stamen Terrain&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span> <span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>

<span class="ne">AttributeError</span>: module &#39;matplotlib.cm&#39; has no attribute &#39;get_cmap&#39;
</pre></div>
</div>
</div>
</div>
<p>Take a moment to click around the map and read about some of the incidents.</p>
<p>Between presenting this information on a map and the list on <a class="reference external" href="https://www.avalanche.ca/incidents/">https://www.avalanche.ca/incidents/</a> ,
which do you prefer and why?</p>
</section>
<section id="matching-incidents-to-regions">
<h4>Matching Incidents to Regions<a class="headerlink" href="#matching-incidents-to-regions" title="Permalink to this heading">#</a></h4>
<p>Later, we will want to match incidents to forecasts, so let’s find the closest region to each incident.</p>
<p>Note that distance here will be in units of latitude, longitude (or
whatever coordinate system we use). At the equator, a distance of 1 is
approximately 60 nautical miles.</p>
<p>Since longitude lines get closer together farther from the equator,
these distances will be understated the further North you go.</p>
<p>This is not much of a problem if we’re just finding the
nearest region, but if we care about accurate distances, we should
re-project the latitude and longitude into a different coordinate system.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Match incidents to nearest forecast regions.</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">Polygon</span><span class="p">,</span> <span class="n">shape</span>
<span class="n">point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">incidents</span><span class="o">.</span><span class="n">latlon_filled</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">incidents</span><span class="o">.</span><span class="n">latlon_filled</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">distances</span><span class="p">(</span><span class="n">latlon</span><span class="p">):</span>
    <span class="n">point</span><span class="o">=</span><span class="n">Point</span><span class="p">(</span><span class="n">latlon</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">latlon</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">([{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="n">feature</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                                  <span class="s1">&#39;distance&#39;</span><span class="p">:</span><span class="n">shape</span><span class="p">(</span><span class="n">feature</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">point</span><span class="p">)}</span> <span class="k">for</span>
                                 <span class="n">feature</span> <span class="ow">in</span> <span class="n">forecastregions</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]])</span>
    <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">distances</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()])</span>
<span class="n">incidents</span><span class="p">[</span><span class="s1">&#39;nearest_region&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">incidents</span><span class="o">.</span><span class="n">latlon_filled</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
<span class="n">incidents</span><span class="p">[</span><span class="s1">&#39;nearest_distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">incidents</span><span class="o">.</span><span class="n">latlon_filled</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="kc">None</span> <span class="k">else</span> <span class="n">distances</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">incidents</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="forecast-data">
<h4>Forecast Data<a class="headerlink" href="#forecast-data" title="Permalink to this heading">#</a></h4>
<p>We’ll now download all forecasts for all regions since November 2011 (roughly the earliest data available).</p>
<p>We can only request one forecast at a time, so this takes many hours to download.</p>
<p>To make this process run more quickly for readers, we ran the code ourselves and then stored the data in the cloud.</p>
<p>The function below will fetch all the forecasts from the cloud storage location and save them to a folder
named <code class="docutils literal notranslate"><span class="pre">avalanche_forecasts</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">download_cached_forecasts</span><span class="p">():</span>
    <span class="c1"># download the zipped file and unzip it here</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://datascience.quantecon.org/assets/data/avalanche_forecasts.zip?raw=true&quot;</span>
    <span class="k">with</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">res</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;failed to download the cached forecasts&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">content</span><span class="p">))</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">z</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">and</span> <span class="n">z</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">file_size</span> <span class="o">&lt;</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span><span class="p">):</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;File $f exists and is larger than version in cache. Not replacing.&quot;</span><span class="p">)</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">z</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">download_cached_forecasts</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The code below is what we initially ran to obtain all the forecasts.</p>
<p>You will notice that this code checks to see whether the files can be found in the <code class="docutils literal notranslate"><span class="pre">avalanche_forecasts</span></code>
directory (they can if you ran the <code class="docutils literal notranslate"><span class="pre">download_cached_forecasts</span></code> above!) and will only download them if they aren’t found.</p>
<p>You can experiment with this caching by deleting one or more files from the <code class="docutils literal notranslate"><span class="pre">avalanche_forecasts</span></code>
folder and re-running the cells below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Functions for downloading forecasts from Avalanche Canada</span>

<span class="k">def</span> <span class="nf">get_forecast</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://www.avalanche.ca/api/bulletin-archive/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">.json&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span><span class="n">region</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="k">return</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_forecasts</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
    <span class="n">day</span> <span class="o">=</span> <span class="n">start</span>
    <span class="n">forecasts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span><span class="p">(</span><span class="n">day</span><span class="o">&lt;=</span><span class="n">end</span> <span class="ow">and</span> <span class="n">day</span><span class="o">&lt;</span><span class="n">end</span><span class="o">.</span><span class="n">today</span><span class="p">()):</span>
        <span class="c1">#print(&quot;working on {}, {}&quot;.format(region,day))</span>
        <span class="n">forecasts</span> <span class="o">=</span> <span class="n">forecasts</span> <span class="o">+</span> <span class="p">[</span><span class="n">get_forecast</span><span class="p">(</span><span class="n">day</span><span class="p">,</span> <span class="n">region</span><span class="p">)]</span>
        <span class="c1">#print(&quot;sleeping&quot;)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span> <span class="c1"># to avoid too much load on Avalanche Canada servers</span>
        <span class="n">day</span> <span class="o">=</span> <span class="n">day</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;D&quot;</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">forecasts</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_season</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
    <span class="n">start_month</span> <span class="o">=</span> <span class="mi">11</span>
    <span class="n">start_day</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">last_month</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">last_day</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s2">&quot;avalanche_forecasts&quot;</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s2">&quot;avalanche_forecasts&quot;</span><span class="p">)</span>
    <span class="n">seasonfile</span> <span class="o">=</span> <span class="s2">&quot;avalanche_forecasts/</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">.json&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">year</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">seasonfile</span><span class="p">)):</span>
        <span class="n">startdate</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> 12:00&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">start_month</span><span class="p">,</span> <span class="n">start_day</span><span class="p">))</span>
        <span class="n">lastdate</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> 12:00&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">last_month</span><span class="p">,</span> <span class="n">last_day</span><span class="p">))</span>
        <span class="n">season</span> <span class="o">=</span> <span class="n">get_forecasts</span><span class="p">(</span><span class="n">startdate</span><span class="p">,</span><span class="n">lastdate</span><span class="p">,</span><span class="n">region</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">seasonfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">season</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">seasonfile</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_data</span><span class="p">:</span>
            <span class="n">season</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">season</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">forecastlist</span><span class="o">=</span><span class="p">[]</span>

<span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2011</span><span class="p">,</span><span class="mi">2019</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;working on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="p">[</span><span class="n">region</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">forecastregions</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">]]:</span>
        <span class="n">forecastlist</span> <span class="o">=</span> <span class="n">forecastlist</span> <span class="o">+</span> <span class="n">get_season</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># convert to DataFrame and extract some variables</span>
<span class="n">forecasts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">forecastlist</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">==</span><span class="kc">None</span><span class="p">],</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>

<span class="n">forecasts</span><span class="p">[</span><span class="s2">&quot;danger_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">forecasts</span><span class="o">.</span><span class="n">dangerRatings</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;date&quot;</span><span class="p">])</span>
<span class="n">forecasts</span><span class="p">[</span><span class="s2">&quot;danger_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">forecasts</span><span class="o">.</span><span class="n">danger_date</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
<span class="n">forecasts</span><span class="p">[</span><span class="s2">&quot;danger_alpine&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">forecasts</span><span class="o">.</span><span class="n">dangerRatings</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;dangerRating&quot;</span><span class="p">][</span><span class="s2">&quot;alp&quot;</span><span class="p">])</span>
<span class="n">forecasts</span><span class="p">[</span><span class="s2">&quot;danger_treeline&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">forecasts</span><span class="o">.</span><span class="n">dangerRatings</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;dangerRating&quot;</span><span class="p">][</span><span class="s2">&quot;tln&quot;</span><span class="p">])</span>
<span class="n">forecasts</span><span class="p">[</span><span class="s2">&quot;danger_belowtree&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">forecasts</span><span class="o">.</span><span class="n">dangerRatings</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;dangerRating&quot;</span><span class="p">][</span><span class="s2">&quot;btl&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">forecasts</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># merge incidents to forecasts</span>
<span class="n">adf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">forecasts</span><span class="p">,</span> <span class="n">incidents</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
               <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">,</span><span class="s2">&quot;danger_date&quot;</span><span class="p">],</span>
               <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;nearest_region&quot;</span><span class="p">,</span><span class="s2">&quot;date&quot;</span><span class="p">],</span>
              <span class="n">indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">adf</span><span class="p">[</span><span class="s2">&quot;incident&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adf</span><span class="o">.</span><span class="n">_merge</span><span class="o">==</span><span class="s2">&quot;both&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There were </span><span class="si">{}</span><span class="s2"> incidents matched with forecasts data. These occured on </span><span class="si">{}% o</span><span class="s2">f day-regions with forecasts&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">adf</span><span class="o">.</span><span class="n">incident</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="n">adf</span><span class="o">.</span><span class="n">incident</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="n">ratings</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">adf</span><span class="o">.</span><span class="n">danger_alpine</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">ava_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#52BA4A&quot;</span><span class="p">,</span> <span class="s2">&quot;#FFF300&quot;</span><span class="p">,</span> <span class="s2">&quot;#F79218&quot;</span><span class="p">,</span> <span class="s2">&quot;#EF1C29&quot;</span><span class="p">,</span> <span class="s2">&quot;#1A1A1A&quot;</span><span class="p">,</span> <span class="s2">&quot;#BFBFBF&quot;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;danger_alpine&quot;</span><span class="p">,</span> <span class="s2">&quot;danger_treeline&quot;</span><span class="p">,</span> <span class="s2">&quot;danger_belowtree&quot;</span><span class="p">]:</span>
    <span class="n">fig</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">catplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="s2">&quot;incident&quot;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">ratings</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">adf</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">palette</span><span class="o">=</span><span class="n">ava_colors</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;danger_&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">))</span>
    <span class="n">display</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="predicting-incidents-from-text">
<h2>Predicting Incidents from Text<a class="headerlink" href="#predicting-incidents-from-text" title="Permalink to this heading">#</a></h2>
<section id="preprocessing">
<h3>Preprocessing<a class="headerlink" href="#preprocessing" title="Permalink to this heading">#</a></h3>
<p>The first step when using text as data is to pre-process the text.</p>
<p>In preprocessing, we will:</p>
<ol class="arabic simple">
<li><p>Clean: Remove unwanted punctuation and non-text characters.</p></li>
<li><p>Tokenize: Break sentences down into words.</p></li>
<li><p>Remove “stopwords”: Eliminate common words that actually provide no information, like “a” and “the”.</p></li>
<li><p>Lemmatize words: Reduce words to their dictionary “lemma” e.g. “snowing” and “snowed” both become snow (verb).</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">import</span> <span class="nn">nltk</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;omw-1.4&#39;</span><span class="p">)</span>
<span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;punkt&#39;</span><span class="p">)</span>
<span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;stopwords&#39;</span><span class="p">)</span>
<span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;wordnet&#39;</span><span class="p">)</span>
<span class="c1"># Remove stopwords (the, a, is, etc)</span>
<span class="n">stopwords</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nltk</span><span class="o">.</span><span class="n">corpus</span><span class="o">.</span><span class="n">stopwords</span><span class="o">.</span><span class="n">words</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">))</span>
<span class="n">stopwords</span><span class="o">=</span><span class="n">stopwords</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">))</span>
<span class="c1"># Lemmatize words e.g. snowed and snowing are both snow (verb)</span>
<span class="n">wnl</span> <span class="o">=</span> <span class="n">nltk</span><span class="o">.</span><span class="n">WordNetLemmatizer</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">text_prep</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="s2">&quot;lxml&quot;</span><span class="p">)</span>
    <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">soup</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">)]</span> <span class="c1"># remove css</span>
    <span class="n">txt</span><span class="o">=</span><span class="n">soup</span><span class="o">.</span><span class="n">text</span> <span class="c1"># remove html tags</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">nltk</span><span class="o">.</span><span class="n">tokenize</span><span class="o">.</span><span class="n">word_tokenize</span><span class="p">(</span><span class="n">txt</span><span class="p">)]</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">stopwords</span><span class="p">]</span>
    <span class="c1">#tokens = [token for token in tokens if not token ]</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">wnl</span><span class="o">.</span><span class="n">lemmatize</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;EMPTYSTRING&quot;</span><span class="p">]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>

<span class="n">text_prep</span><span class="p">(</span><span class="n">forecasts</span><span class="o">.</span><span class="n">highlights</span><span class="p">[</span><span class="mi">1000</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Now, let’s apply this to all avalanche summaries.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">text_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">text_prep</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span> <span class="k">for</span> <span class="n">txt</span> <span class="ow">in</span> <span class="n">adf</span><span class="o">.</span><span class="n">avalancheSummary</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s make a bar plot of the most common words.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wf</span> <span class="o">=</span> <span class="n">nltk</span><span class="o">.</span><span class="n">FreqDist</span><span class="p">([</span><span class="n">word</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">text_data</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">])</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">wf</span><span class="p">]</span>
<span class="n">cnt</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">wf</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)),</span> <span class="n">cnt</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)));</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Most common words in avalanche summaries&#39;</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Word&#39;</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Occurences&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="feature-engineering">
<h3>Feature Engineering<a class="headerlink" href="#feature-engineering" title="Permalink to this heading">#</a></h3>
<p>The “bag of words” approach is the simplest way to convert a collection of processed text
documents to a feature matrix. We view
each document as a bag of words, and our feature matrix
counts how many times each word appears. This method is called a “bag of words”
because we ignore the document’s word order.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">CountVectorizer</span><span class="p">,</span> <span class="n">TfidfVectorizer</span>
<span class="n">vectorizer</span> <span class="o">=</span> <span class="n">CountVectorizer</span><span class="p">(</span><span class="n">max_features</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">min_df</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_df</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">text_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">text_prep</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span> <span class="k">for</span> <span class="n">txt</span> <span class="ow">in</span> <span class="n">adf</span><span class="o">.</span><span class="n">avalancheSummary</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">adf</span><span class="o">.</span><span class="n">incident</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">([</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">text_data</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>We can also perform more complicated feature engineering. One extension of the “bag of words” method
is to consider counts of pairs or triples of consecutive words. These
are called n-grams and can be created by setting the <code class="docutils literal notranslate"><span class="pre">n_gram</span></code>
argument to <code class="docutils literal notranslate"><span class="pre">CountVectorizer</span></code>. Another alternative might be to accommodate
the fact that common words will inherently have higher counts by using
term-frequency inverse-document-frequency (see below).</p>
<p>After creating our feature matrix, we can now apply any classification
method to predict incidents.</p>
</section>
<section id="naive-bayes-classifier">
<h3>Naive Bayes Classifier<a class="headerlink" href="#naive-bayes-classifier" title="Permalink to this heading">#</a></h3>
<p>A common text data classifier is the Naive Bayes classifier.
This classifier predicts incidents using Bayes’ rules.</p>
<div class="math notranslate nohighlight">
\[
P(incident | words) = \frac{P(words|incident) P(incidents)}{P(words)}
\]</div>
<p>The classifier is naive, though; it assumes words are independent of one another in any given incident.</p>
<div class="math notranslate nohighlight">
\[
P(words|incident) = \prod_{w \in words} P(w|incident)
\]</div>
<p>Although this assumption is implausible for text, the Naive Bayes
classifier can be computed extremely quickly, and sometimes quite well.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="n">Xtrain</span><span class="p">,</span> <span class="n">Xtest</span><span class="p">,</span> <span class="n">ytrain</span><span class="p">,</span> <span class="n">ytest</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">124</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">naive_bayes</span>
<span class="n">classifier</span> <span class="o">=</span> <span class="n">naive_bayes</span><span class="o">.</span><span class="n">MultinomialNB</span><span class="p">()</span>
<span class="n">classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xtrain</span><span class="p">,</span><span class="n">ytrain</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xtest</span><span class="p">)</span><span class="o">==</span><span class="n">ytest</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">metrics</span>
<span class="nb">print</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">ytest</span><span class="p">,</span> <span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xtest</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">classification_report</span><span class="p">(</span><span class="n">ytest</span><span class="p">,</span> <span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xtest</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># print text with highest predicted probabilities</span>
<span class="n">phat</span><span class="o">=</span><span class="n">classifier</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">remove_html</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="s2">&quot;lxml&quot;</span><span class="p">)</span>
    <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">soup</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">)]</span> <span class="c1"># remove css</span>
    <span class="k">return</span><span class="p">(</span><span class="n">soup</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="n">docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">remove_html</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span> <span class="k">for</span> <span class="n">txt</span> <span class="ow">in</span> <span class="n">adf</span><span class="o">.</span><span class="n">avalancheSummary</span><span class="p">]</span>
<span class="n">txt_high</span> <span class="o">=</span> <span class="p">[(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">phat</span><span class="p">,</span><span class="n">docs</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">pair</span><span class="p">:</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
<span class="n">txt_high</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># print text with lowest predicted probabilities</span>
<span class="n">txt_low</span> <span class="o">=</span> <span class="p">[(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">phat</span><span class="p">,</span><span class="n">docs</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">pair</span><span class="p">:</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
<span class="n">txt_low</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition-exercise admonition" id="app-txt-dir1">
<p class="admonition-title">Exercise</p>
<p>See exercise 1 in the <a class="reference internal" href="#app-txt-ex"><span class="std std-ref">exercise list</span></a>.</p>
</div>
<p>Predicting deaths from forecast text is very difficult because deaths
are so rare. A prediction exercise more likely to succeed would be to
predict the avalanche rating from the forecast text. However,
doing so is a very
artificial task, with little practical use.</p>
<p>Another alternative would be to gather more data on non-fatal
avalanches. Avalanche Canada also has user-submitted “Mountain
Information Network” reports. These reports include observations of
natural avalanches and information on non-fatal avalanche
incidents. Since the data is user-submitted, it is messy and more
difficult to work with. Nonetheless, working with it would be
good practice and could lead to some insights.</p>
</section>
</section>
<section id="unsupervised-learning">
<h2>Unsupervised Learning<a class="headerlink" href="#unsupervised-learning" title="Permalink to this heading">#</a></h2>
<p>The regression and classification methods that we have seen so far are
examples of supervised learning — we are trying to predict an observed outcome.
In unsupervised learning, we do not have an
observed outcome to predict. Instead, we try to find informative
patterns in the data. Unsupervised learning can be particularly useful
with text data. We will look at two related techniques for topic
modeling. These techniques attempt to extract distinct topics from a
collection of text documents.</p>
<section id="latent-semantic-analysis">
<h3>Latent Semantic Analysis<a class="headerlink" href="#latent-semantic-analysis" title="Permalink to this heading">#</a></h3>
<p>Latent semantic analysis is used by some search engines to rank
the similarities among documents. Latent semantic analysis begins with a
term document matrix, <span class="math notranslate nohighlight">\(X\)</span>. The term document matrix is a number
of documents by number of terms matrix where the i,jth entry is the
measure of how often term j appears in document i. This could be the
same bag of words feature matrix we constructed above, or it could be
some other measure. For this example, we will use the term-frequency,
inverse-document-frequency representation.</p>
<div class="math notranslate nohighlight">
\[
x^{tfidf}_{ij} = \frac{\text{occurences of term j in document
i}}{\text{length of document i}} \log \left(\frac{\text{number of
documents}}{\text{number of documents containing term j}}\right)
\]</div>
<p>Given a term document matrix, <span class="math notranslate nohighlight">\(X\)</span>, latent semantic analysis
computes a lower rank approximation to <span class="math notranslate nohighlight">\(X\)</span> through the singular
value decomposition. This lower rank approximation can potentially be
interpreted or used instead of <span class="math notranslate nohighlight">\(X\)</span> for other learning
algorithms. In other contexts, similar decompositions are referred to
as principal components analysis or factor models.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># LSA</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">TfidfVectorizer</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">TruncatedSVD</span>
<span class="n">tfidf_vectorizer</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">(</span><span class="n">use_idf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">smooth_idf</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">tfidf_vectorizer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">([</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">text_data</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">svd_model</span> <span class="o">=</span> <span class="n">TruncatedSVD</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;randomized&#39;</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">122</span><span class="p">)</span>
<span class="n">svd_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here, we have computed a rank 10 approximation to the tf-idf matrix. We
can see how much variance of the original matrix that our 10
components reproduce. We can also look at how all terms in the
document contribute to each of the 10 components.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">svd_model</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">svd_model</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="o">.</span><span class="n">cumsum</span><span class="p">())</span>
<span class="n">terms</span> <span class="o">=</span> <span class="n">tfidf_vectorizer</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span> 
<span class="n">comp_label</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">svd_model</span><span class="o">.</span><span class="n">components_</span><span class="p">):</span>
    <span class="n">terms_comp</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">terms</span><span class="p">,</span> <span class="n">comp</span><span class="p">)</span>
    <span class="n">sorted_terms</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">terms_comp</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">7</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Topic &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;: &quot;</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">sorted_terms</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">message</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> * </span><span class="si">{}</span><span class="s2"> + &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">comp_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we can attempt to visualize the components.</p>
<p>The LSA reduced the dimensionality of the representation of documents
from thousands (of term-frequency inverse-document-frequency) to ten
components. While ten is more manageable than thousands, it is still too
many dimensions to effectively visualize. t-SNE is a technique to further
reduce dimensionality. t-SNE is a nonlinear data transformation
from many dimensions to 2, while attempting to preserve the
original clustering of their original domain. In other words, if a
set of documents are closely clustered in the 10 dimensional
LSA space, then they will also be close together in the 2 dimensional
t-SNE representation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lsa_topic_matrix</span> <span class="o">=</span> <span class="n">svd_model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.manifold</span> <span class="kn">import</span> <span class="n">TSNE</span>
<span class="n">nplot</span> <span class="o">=</span> <span class="mi">2000</span> <span class="c1"># reduce the size of the data to speed computation and make the plot less cluttered</span>
<span class="n">lsa_topic_sample</span> <span class="o">=</span> <span class="n">lsa_topic_matrix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">lsa_topic_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nplot</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
<span class="n">tsne_lsa_model</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">perplexity</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                      <span class="n">n_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>
<span class="n">tsne_lsa_vectors</span> <span class="o">=</span> <span class="n">tsne_lsa_model</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">lsa_topic_sample</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The t-SNE model creates a
non-linear projection from our 10 dimensional LSA topics onto two dimensional space.
It can be useful for visualizing high-dimensional data. One word of caution:
the output of the t-SNE model can depend on the parameters of the
algorithm. Failure to see clear clusters in the t-SNE visualization
could mean either the original data was not clustered in higher
dimensional space or that the t-SNE algorithm parameters were
chosen poorly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cmap</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;Paired&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">n_topics</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">svd_model</span><span class="o">.</span><span class="n">components_</span><span class="p">)</span>
<span class="n">lsa_keys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">lsa_topic_sample</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">tsne_lsa_vectors</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">y</span><span class="o">=</span><span class="n">tsne_lsa_vectors</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lsa_keys</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">bbox_props</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round4,pad=0.1&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_topics</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">tsne_lsa_vectors</span><span class="p">[</span><span class="n">lsa_keys</span><span class="o">==</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
               <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
               <span class="n">bbox</span><span class="o">=</span><span class="n">bbox_props</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">n_topics</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="s2">&quot;Topic &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; : &quot;</span><span class="o">+</span> <span class="n">comp_label</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>From this plot, we can immediately see two things. First, most documents
are closest to topic 0. Second, most topics are not
well-separated.</p>
<div class="admonition-exercise admonition" id="app-txt-dir2">
<p class="admonition-title">Exercise</p>
<p>See exercise 2 in the <a class="reference internal" href="#app-txt-ex"><span class="std std-ref">exercise list</span></a>.</p>
</div>
</section>
<section id="latent-dirichlet-analysis">
<h3>Latent Dirichlet Analysis<a class="headerlink" href="#latent-dirichlet-analysis" title="Permalink to this heading">#</a></h3>
<p>Latent dirichlet analysis (LDA) produces similar outputs as latent semantic
analysis, but LDA often produces nicer results. The statistical theory
underlying LSA is built on continuous <span class="math notranslate nohighlight">\(X\)</span> features. LDA uses
similar ideas, but takes into account that text is discrete.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># LDA</span>
<span class="kn">import</span> <span class="nn">gensim</span>
<span class="c1"># gensim works with a list of lists of tokens</span>
<span class="n">text_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">text_prep</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span> <span class="k">for</span> <span class="n">txt</span> <span class="ow">in</span> <span class="n">forecasts</span><span class="o">.</span><span class="n">avalancheSummary</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># convert to bag of words</span>
<span class="n">dictionary</span> <span class="o">=</span> <span class="n">gensim</span><span class="o">.</span><span class="n">corpora</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">text_data</span><span class="p">)</span>
<span class="n">bow_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">dictionary</span><span class="o">.</span><span class="n">doc2bow</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">text_data</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ldamodel</span> <span class="o">=</span> <span class="n">gensim</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">ldamodel</span><span class="o">.</span><span class="n">LdaModel</span><span class="p">(</span><span class="n">bow_data</span><span class="p">,</span> <span class="n">num_topics</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">id2word</span><span class="o">=</span><span class="n">dictionary</span><span class="p">,</span> <span class="n">passes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">topics</span> <span class="o">=</span> <span class="n">ldamodel</span><span class="o">.</span><span class="n">print_topics</span><span class="p">(</span><span class="n">num_words</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">topics</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">topic</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pyLDAvis</span>
<span class="kn">import</span> <span class="nn">pyLDAvis.gensim_models</span>
<span class="n">pyLDAvis</span><span class="o">.</span><span class="n">enable_notebook</span><span class="p">()</span>
<span class="n">lda_display</span> <span class="o">=</span> <span class="n">pyLDAvis</span><span class="o">.</span><span class="n">gensim_models</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">ldamodel</span><span class="p">,</span> <span class="n">bow_data</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">)</span>
<span class="n">lda_display</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition-exercise admonition" id="app-txt-dir3">
<p class="admonition-title">Exercise</p>
<p>See exercise 3 in the <a class="reference internal" href="#app-txt-ex"><span class="std std-ref">exercise list</span></a>.</p>
</div>
<div class="admonition-exercise admonition" id="app-txt-dir4">
<p class="admonition-title">Exercise</p>
<p>See exercise 4 in the <a class="reference internal" href="#app-txt-ex"><span class="std std-ref">exercise list</span></a>.</p>
</div>
</section>
</section>
<section id="exercises">
<span id="app-txt-ex"></span><h2>Exercises<a class="headerlink" href="#exercises" title="Permalink to this heading">#</a></h2>
<section id="exercise-1">
<h3>Exercise 1<a class="headerlink" href="#exercise-1" title="Permalink to this heading">#</a></h3>
<p>Use another classification method to predict incidents. Check whether
your method outperforms the Naive Bayes classifier.</p>
<p>(<a class="reference internal" href="#app-txt-dir1"><span class="std std-ref">back to text</span></a>)</p>
</section>
<section id="exercise-2">
<h3>Exercise 2<a class="headerlink" href="#exercise-2" title="Permalink to this heading">#</a></h3>
<p>Apply LSA to the weather or snowpack descriptions. Can you notice
any patterns?</p>
<p>(<a class="reference internal" href="#app-txt-dir2"><span class="std std-ref">back to text</span></a>)</p>
</section>
<section id="exercise-3">
<h3>Exercise 3<a class="headerlink" href="#exercise-3" title="Permalink to this heading">#</a></h3>
<p>Apply LDA to the weather or snowpack descriptions. Can you notice
any patterns?</p>
<p>(<a class="reference internal" href="#app-txt-dir3"><span class="std std-ref">back to text</span></a>)</p>
</section>
<section id="exercise-4">
<h3>Exercise 4<a class="headerlink" href="#exercise-4" title="Permalink to this heading">#</a></h3>
<p>Use the reduced rank representation of text from LSA or LDA as a
feature matrix to predict avalanche incidents. Compare the
performance with the bag of words feature matrix.</p>
<p>(<a class="reference internal" href="#app-txt-dir4"><span class="std std-ref">back to text</span></a>)</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./applications"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                    </div>
                    
                </main> <!-- .page__content -->
                


                <footer class="qe-page__footer">

                    <p><a href="https://creativecommons.org/licenses/by-sa/4.0/"><img src="https://licensebuttons.net/l/by-sa/4.0/80x15.png"></a></p>

                    <p>Creative Commons License &ndash; This work is licensed under a Creative Commons Attribution-ShareAlike 4.0 International.</p>

                </footer> <!-- .page__footer -->

            </div> <!-- .page -->

            

            
            <div class="qe-sidebar bd-sidebar inactive persistent" id="site-navigation">

                <div class="qe-sidebar__header">


                    Contents

                </div>

                <nav class="qe-sidebar__nav" id="qe-sidebar-nav" aria-label="Main navigation">
                    <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Introduction
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/index.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/overview.html">
   Course Description
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/getting_started.html">
   Getting Started
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/cloud_setup.html">
   Cloud Setup
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/local_install.html">
   Local Installation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/troubleshooting.html">
   Troubleshooting
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Python Fundamentals
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../python_fundamentals/index.html">
   Python Fundamentals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../python_fundamentals/basics.html">
   Basics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../python_fundamentals/collections.html">
   Collections
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../python_fundamentals/control_flow.html">
   Control Flow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../python_fundamentals/functions.html">
   Functions
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Scientific Computing
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../scientific/index.html">
   Scientific Computing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../scientific/numpy_arrays.html">
   Introduction to Numpy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../scientific/plotting.html">
   Plotting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../scientific/applied_linalg.html">
   Applied Linear Algebra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../scientific/randomness.html">
   Randomness
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../scientific/optimization.html">
   Optimization
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Pandas
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../pandas/index.html">
   DataFrames and Series in Pandas
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../pandas/intro.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../pandas/basics.html">
   Basic Functionality
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../pandas/the_index.html">
   The Index
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../pandas/storage_formats.html">
   Storage Formats
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../pandas/data_clean.html">
   Cleaning Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../pandas/reshape.html">
   Reshape
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../pandas/merge.html">
   Merge
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../pandas/groupby.html">
   GroupBy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../pandas/timeseries.html">
   Time series
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Data Science Tools
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../tools/index.html">
   Data Science Tools
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tools/matplotlib.html">
   Intermediate Plotting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tools/maps.html">
   Mapping in Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tools/visualization_rules.html">
   Data Visualization: Rules and Guidelines
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tools/regression.html">
   Regression
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tools/classification.html">
   Classification
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Applications
 </span>
</p>
<ul class="current nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="index.html">
   Applications
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ml_in_economics.html">
   Machine Learning in Economics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="networks.html">
   Social and Economic Networks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="recidivism.html">
   Case Study: Recidivism
  </a>
 </li>
 <li class="toctree-l1 current active active">
  <a class="current reference internal" href="#">
   Working with Text
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="heterogeneity.html">
   Heterogeneous Effects
  </a>
 </li>
</ul>

                </nav>

                <div class="qe-sidebar__footer">

                </div>

            </div> <!-- .sidebar -->
            
        </div> <!-- .main -->

        <div class="qe-toolbar">

            <div class="qe-toolbar__inner">

                <ul class="qe-toolbar__main">
                    <li data-tippy-content="Table of Contents" class="btn__sidebar"><i data-feather="menu"></i></li>
                    <li data-tippy-content="Home"><a href="../index.html"><i data-feather="home"></i></a></li>
                    <li class="btn__qelogo"><a href="https://quantecon.org" title=""><span class="show-for-sr">QuantEcon</span></a></li>
                    <!-- <li class="btn__search">
                        <form action="../search.html" method="get">
                            <input type="search" class="form-control" name="q" id="search-input" placeholder="Search..." aria-label="Search..." autocomplete="off">
                            <i data-feather="search"></i>
                        </form>
                    </li> -->
                </ul>

                <ul class="qe-toolbar__links">
                    <li data-tippy-content="Fullscreen" class="btn__fullscreen"><i data-feather="maximize"></i></li>
                    <li data-tippy-content="Increase font size" class="btn__plus"><i data-feather="plus-circle"></i></li>
                    <li data-tippy-content="Decrease font size" class="btn__minus"><i data-feather="minus-circle"></i></li>
                    <li data-tippy-content="Change contrast" class="btn__contrast"><i data-feather="sunset"></i></li>
                    <li data-tippy-content="Download Notebook"><a href="/_notebooks/applications/working_with_text.ipynb" download><i data-feather="download-cloud"></i></a></li>
                    <li class="settings-button" id="settingsButton"><div data-tippy-content="Launch Notebook"><i data-feather="play-circle"></i></div></li>
                        <li data-tippy-content="Download PDF" onClick="window.print()"><i data-feather="file"></i></li>
                    <li data-tippy-content="View Source"><a target="_blank" href="https://github.com/QuantEcon/lecture-datascience.myst/tree/main/lectures/applications/working_with_text.md" download><i data-feather="github"></i></a></li>
                </ul>

            </div>

        </div> <!-- .toolbar -->
        <div id="downloadPDFModal" style="display: none;">
            <ul class="pdf-options" style="display: block;">
                <li class="download-pdf-book" onClick="window.print()">
                    <p>Lecture (PDF)</p>
                </li>
                <li class="download-pdf-file">
                    <a href="" download><p>Book (PDF)</p></a>
                </li>
            </ul>
        </div>
        <div id="settingsModal" style="display: none;">
            <p class="modal-title"> Notebook Launcher </p>
            <div class="modal-desc">
            <p>
                Choose public or private cloud service for "Launch" button.
            </p>
            </div>
            <p class="modal-subtitle">Select a server</p>
            <ul class="modal-servers">
            <li class="active launcher-public">
                <span class="label">Public</span>
                <select id="launcher-public-input">
                
                    <option value="https://mybinder.org/v2/gh/QuantEcon/lecture-datascience.notebooks/main?urlpath=tree/applications/working_with_text.ipynb">BinderHub</option>
                
                    <option value="https://colab.research.google.com/github/QuantEcon/lecture-datascience.notebooks/blob/main/applications/working_with_text.ipynb">Colab</option>
                
                </select>
                <i class="fas fa-check-circle"></i>
            </li>
            <li class="launcher-private">
                <span class="label">Private</span>
                <input type="text" id="launcher-private-input" data-repourl="https://github.com/QuantEcon/lecture-datascience.notebooks" data-urlpath="tree/lecture-datascience.notebooks/applications/working_with_text.ipynb" data-branch=main>
                <i class="fas fa-check-circle"></i>
            </li>
            </ul>
            <p class="launch"><a href="https://mybinder.org/v2/gh/QuantEcon/lecture-datascience.notebooks/main?urlpath=tree/applications/working_with_text.ipynb" id="advancedLaunchButton" target="_blank">Launch Notebook</a></p>
            <script>
                // QuantEcon Notebook Launcher
                const launcherTypeElements = document.querySelectorAll('#settingsModal .modal-servers li');
                // Highlight the server type if previous selection exists
                if (typeof localStorage.launcherType !== 'undefined') {
                  for (var i = 0; i < launcherTypeElements.length; i++) {
                    launcherTypeElements[i].classList.remove('active');
                    if ( launcherTypeElements[i].classList.contains(localStorage.launcherType) ) {
                      launcherTypeElements[i].classList.add('active');
                    }
                  }
                }
                // Highlight server type on click and set local storage value
                for (var i = 0; i < launcherTypeElements.length; i++) {
                  launcherTypeElements[i].addEventListener('click', function() {
                    for (var j = 0; j < launcherTypeElements.length; j++) {
                      launcherTypeElements[j].classList.remove('active');
                    }
                    this.classList.add('active');
                    if ( this.classList.contains('launcher-private') ) {
                      localStorage.launcherType = 'launcher-private';
                    } else if ( this.classList.contains('launcher-public') ) {
                      localStorage.launcherType = 'launcher-public';
                    }
                    setLaunchServer();
                  })
                }
                const launcherPublic = document.getElementById('launcher-public-input');
                const launcherPrivate = document.getElementById('launcher-private-input');
                const pageName = "applications/working_with_text";
                const repoURL = "https://github.com/QuantEcon/lecture-datascience.notebooks";
                const urlPath = "tree/lecture-datascience.notebooks/applications/working_with_text.ipynb";
                const branch = "main"
                const launchNotebookLink = document.getElementById('advancedLaunchButton');

                // Highlight public server option if previous selection exists
                if (typeof localStorage.launcherPublic !== 'undefined') {
                  launcherPublic.value = localStorage.launcherPublic;
                }
                // Update local storage upon public server selection
                launcherPublic.addEventListener('change', (event) => {
                  setLaunchServer();
                });
                // Populate private server input if previous entry exists
                if (typeof localStorage.launcherPrivate !== 'undefined') {
                  launcherPrivate.value = localStorage.launcherPrivate;
                }
                // Update local storage when a private server is entered
                launcherPrivate.addEventListener('input', (event) => {
                  setLaunchServer();
                });

                // Function to update the "Launch Notebook" link href
                function setLaunchServer() {
                  launchNotebookLink.removeAttribute("style")
                  if ( localStorage.launcherType == 'launcher-private' ) {
                    let repoPrefix = "/jupyter/hub/user-redirect/git-pull?repo=" + repoURL + "&branch=" + branch + "&urlpath=" + urlPath;
                    launcherPrivateValue = launcherPrivate.value
                    if (!launcherPrivateValue) {
                        launchNotebookLink.removeAttribute("href")
                        launchNotebookLink.style.background = "grey"
                        return
                    }
                    localStorage.launcherPrivate = launcherPrivateValue;
                    privateServer = localStorage.launcherPrivate.replace(/\/$/, "")
                    if (!privateServer.includes("http")) {
                        privateServer = "http://" + privateServer
                    }
                    launchNotebookLinkURL = privateServer + repoPrefix;
                  } else if ( localStorage.launcherType == 'launcher-public' ) {
                    launcherPublicValue = launcherPublic.options[launcherPublic.selectedIndex].value;
                    localStorage.launcherPublic = launcherPublicValue;
                    launchNotebookLinkURL = localStorage.launcherPublic;
                  }
                  if (launchNotebookLinkURL) launchNotebookLink.href = launchNotebookLinkURL;
                }
                // Check if user has previously selected a server
                if ( (typeof localStorage.launcherPrivate !== 'undefined') || (typeof localStorage.launcherPublic !== 'undefined') ) {
                  setLaunchServer();
                }
                </script>

        </div>

    </div> <!-- .wrapper-->
  </body>
</html>